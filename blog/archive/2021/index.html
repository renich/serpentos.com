
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://serpentos.com/blog/archive/2021/">
      
      
        <link rel="prev" href="../2022/">
      
      
        <link rel="next" href="../2020/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS feed" href="../../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="../../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../../static/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.3">
    
    
      
        <title>2021 - Serpent OS</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.50c56a3b.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#2021" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Serpent OS" class="md-header__button md-logo" aria-label="Serpent OS" data-md-component="logo">
      
  <img src="../../../static/logo_white.webp" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Serpent OS
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              2021
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="light-blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../about/" class="md-tabs__link">
        
  
    
  
  About

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../download/" class="md-tabs__link">
        
  
    
  
  Download

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../privacy/" class="md-tabs__link">
        
  
    
  
  Privacy

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../" class="md-tabs__link">
          
  
    
  
  Blog

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Serpent OS" class="md-nav__button md-logo" aria-label="Serpent OS" data-md-component="logo">
      
  <img src="../../../static/logo_white.webp" alt="logo">

    </a>
    Serpent OS
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../download/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Download
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../privacy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Privacy
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Blog
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" checked>
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Archive
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2024/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2023/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    
      
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    2021
  </span>
  

      </a>
      
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2020/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2020
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Categories
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            Categories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/news/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    news
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="2021">2021</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/19542864" alt="Peter O'Connor">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-12-14 18:14:23+11:00">Tuesday, December 14, 2021</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/news/" class="md-meta__link">news</a></li>
        
        
          
          <li class="md-meta__item">
            
              7 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="performance-corner-small-changes-pack-a-punch"><a class="toclink" href="../../2021/12/14/performance-corner-small-changes-pack-a-punch/">Performance Corner: Small Changes Pack a Punch</a></h2>
<p>Here we have another round of changes to make packages smaller and show just how much we care about performance and
efficiency! Today we are focusing mainly on <code>moss-format</code> changes to reduce the size of its payloads. The purpose of
these changes is to reduce the size of packages, DB storage for transactions and memory usage for <code>moss</code>. These changes
were made just before we moved out of bootstrap, so we wouldn't have to rebuild the world after changing the format.
Lets get started!</p>
<!--more-->

<h2 id="squeezing-out-the-last-blit-of-performance"><a class="toclink" href="../../2021/12/14/performance-corner-small-changes-pack-a-punch/#squeezing-out-the-last-blit-of-performance">Squeezing Out the Last Blit of Performance</a></h2>
<p><code>Blitting</code> in Serpent OS is the process of setting up a root, using hardlinks of files installed in the <code>moss</code> store to
construct the system <code>/usr</code> directory. Some initial testing showed <code>buildPath</code> using about 3% of the total events
when installing a package with many files. As a system is made up of over 100,000 files, that's a lot of paths that need
to be calculated! Performance is therefore important to minimize time taken and power consumed.</p>
<p>After running a few benchmarks of <code>buildPath</code>, there were a few tweaks which could improve the performance. Rather than
calculating the full path of the file, we can reuse the constant root path for each file instead, reducing <code>buildPath</code>
events by 15%. Here we see some callgrind data from this small change (as it was difficult to pickup in the noise).</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>Before:
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>   48,766,347 ( 1.50%)  /usr/include/dlang/ldc/std/path.d:pure nothrow @safe immutable(char)[] std.path.buildPath
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>   34,241,805 ( 1.05%)  /usr/include/dlang/ldc/std/utf.d:pure nothrow @safe immutable(char)[] std.path.buildPath
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>   14,363,684 ( 0.44%)  /usr/include/dlang/ldc/std/range/package.d:pure nothrow @safe immutable(char)[] std.path.buildPath
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>After:
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>   40,357,800 ( 1.25%)  /usr/include/dlang/ldc/std/path.d:pure nothrow @safe immutable(char)[] std.path.buildPath
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>   29,523,966 ( 0.91%)  /usr/include/dlang/ldc/std/utf.d:pure nothrow @safe immutable(char)[] std.path.buildPath
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>   12,814,283 ( 0.40%)  /usr/include/dlang/ldc/std/range/package.d:pure nothrow @safe immutable(char)[] std.path.buildPath
</span></code></pre></div>
<h2 id="only-record-whats-needed"><a class="toclink" href="../../2021/12/14/performance-corner-small-changes-pack-a-punch/#only-record-whats-needed">Only Record What's Needed!</a></h2>
<p>Our <code>Index Payload</code> is used for extracting the <code>Content Payload</code> into its hashed file names. As it has one job (and then
discarded), we could hone in on including only the information we needed. Previously an entry was a 32 byte key and
storing a 33 byte hash. We have now integrated the hash as a <code>ubyte[16]</code> field, cut other unneeded fields so that we can
fit the whole entry into 32 bytes. That's a 51% reduction in the size of the <code>Index Payload</code> and about 25% smaller when
compressed.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>Before: Index [Records: 3688 Compression: Zstd, Savings: 60.61%, Size: 239.72 KB]
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>After:  Index [Records: 3688 Compression: Zstd, Savings: 40.03%, Size: 118.02 KB]
</span></code></pre></div>
<h2 id="too-many-entries-makes-for-a-large-payload"><a class="toclink" href="../../2021/12/14/performance-corner-small-changes-pack-a-punch/#too-many-entries-makes-for-a-large-payload">Too Many Entries Makes for a Large Payload</a></h2>
<p>One of the bugbears about the Layout Payload, was the inclusion of <code>Directory</code> paths for every single directory. This is
handy in that directories can be created easily before any files are included (to ensure they exist), but it comes at a
price. The issue was twofold, the extra entries made inspecting the file list take longer and also made the <code>Layout
Payload</code> larger than it needed to be. Therefore directories are no longer included as Layout entries with the exceptions
of empty directories and directories with different permissions. Lets compare <code>nano</code> and <code>glibc</code> builds before and
after the change:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>nano
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>Before: Layout [Records: 174 Compression: Zstd, Savings: 80.58%, Size: 13.78 KB]
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>After:  Layout [Records:  93 Compression: Zstd, Savings: 73.49%, Size:  9.15 KB]
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>glibc
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>Before: Layout [Records: 7879 Compression: Zstd, Savings: 86.88%, Size: 755.00 KB]
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>After:  Layout [Records: 6813 Compression: Zstd, Savings: 86.24%, Size: 689.20 KB]
</span></code></pre></div>
<p>A surprisingly large impact from a small change, with 1,000 fewer entries for <code>glibc</code> and cutting the Layout Payload
size of <code>nano</code> by a third. What it shows is that it's hugely beneficial where locales are involved and % size reduction
increases where you have fewer files. To give an example of how bad it could be, the KDE Frameworks package
<code>ktexteditor</code> would have produced 300 entries in the Layout Payload, where 200 of those would have been for directories!
I'd estimate a 50% reduction in the Layout Payload size for this package! Here's an example of how a locale file used
to be stored (where only the last line is added now).</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>  - /usr/share/locale [Directory]
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>  - /usr/share/locale/bg [Directory]
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>  - /usr/share/locale/bg/LC_MESSAGES [Directory]
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>  - /usr/share/locale/bg/LC_MESSAGES/nano.mo -&gt; ec5b82819ec2355d4e7bbccc7d78ce60 [Regular]
</span></code></pre></div>
<p>This will be exceptionally useful for keeping the <code>LayoutDB</code> slimmer and faster as the number of packages grows.</p>
<h2 id="cutting-back-1-byte-at-a-time"><a class="toclink" href="../../2021/12/14/performance-corner-small-changes-pack-a-punch/#cutting-back-1-byte-at-a-time">Cutting Back 1 Byte at a Time</a></h2>
<p>Next we removed recording the timestamps of files, which for reproducible builds, is often a number of little relevance
as you have to force them all to a fixed number. As <code>moss</code> is de-duplicating for files, there's a second issue where two
packages could have different timestamps for the same hash. Therefore it was considered an improvement to simply exclude
timestamps altogether. This improved install time as we no longer overwrite the timestamps and made the payload more
compressible due to replacing it with 8 bytes of padding. Unfortunately we weren't quite able to free up 16 bytes to
reduce the size of each entry, but will be something to pursue in future.</p>
<p>Another quick improvement was reducing the lengths of paths for each entry. <code>moss</code> creates system roots and switches
between them by changing the <code>/usr</code> symlink. Therefore, all system files need to be installed into <code>/usr</code> or they will
not make up your base system. Therefore we have no need to store <code>/usr</code> in the Payload so we strip <code>/usr/</code> from the
paths (the extra / gives us another byte off!) which we recreate on install. This improved the uncompressed size of the
Payload, with only a minor reduction when compressed.</p>
<p>Combined these result in about a 5% decrease in the compressed and uncompressed size of the <code>Layout Payload</code>.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>Before: Layout [Records: 6812 Compression: Zstd, Savings: 86.24%, Size: 689.10 KB]
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>After: Layout [Records: 6812 Compression: Zstd, Savings: 86.20%, Size: 655.00 KB]
</span></code></pre></div>
<h2 id="storing-the-hash-efficiently"><a class="toclink" href="../../2021/12/14/performance-corner-small-changes-pack-a-punch/#storing-the-hash-efficiently">Storing the Hash Efficiently</a></h2>
<p>Using the same method for the <code>Index Payload</code>, we are now storing the hash as <code>ubyte[16]</code>, but not directly in the
<code>Payload Entry</code>. This gives us a sizeable reduction of 17 bytes per entry which is the most significant of all the
<code>Layout Payload</code> changes. As the extra space was unneeded, it compressed well so only resulted in a small reduction in
the compressed Payload size.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>Before: Layout [Records: 6812 Compression: Zstd, Savings: 86.20%, Size: 655.00 KB]
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>After: Layout [Records: 6812 Compression: Zstd, Savings: 83.92%, Size: 539.26 KB]
</span></code></pre></div>
<p><img alt="Planning payload changes" src="../../../static/img/blog/performance-corner-small-changes-pack-a-punch/Featured.webp" /></p>
<h2 id="hang-on-why-am-i-getting-faster-installation"><a class="toclink" href="../../2021/12/14/performance-corner-small-changes-pack-a-punch/#hang-on-why-am-i-getting-faster-installation">Hang On, Why am I Getting Faster Installation?</a></h2>
<p>As a side-effect of small code rewrites to implement these changes, we've seen a nice decrease in time to install
packages. There are fewer entries to iterate over with the removal of directories and <code>buildPath</code> is now only called
once for each path. It goes to show that focusing on the small details leads to less, more efficient and faster code.
Here we find that we have now essentially halved the number of events related to <code>buildPath</code> with all the changes
resulting in about a 5% reduction in install time. Note that for this test, over 80% of time is spent in <code>zstd</code>
decompressing the package which we haven't optimized (yet!). Here's another look the <code>buildPath</code> numbers factoring in
all the changes:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>Before:
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>   48,766,347 ( 1.50%)  /usr/include/dlang/ldc/std/path.d:pure nothrow @safe immutable(char)[] std.path.buildPath
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>   34,241,805 ( 1.05%)  /usr/include/dlang/ldc/std/utf.d:pure nothrow @safe immutable(char)[] std.path.buildPath
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>   14,363,684 ( 0.44%)  /usr/include/dlang/ldc/std/range/package.d:pure nothrow @safe immutable(char)[] std.path.buildPath
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>After:
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>   25,145,625 ( 0.79%)  /usr/include/dlang/ldc/std/path.d:pure nothrow @safe immutable(char)[] std.path.buildPath
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>   17,967,216 ( 0.57%)  /usr/include/dlang/ldc/std/utf.d:pure nothrow @safe immutable(char)[] std.path.buildPath
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>    7,761,417 ( 0.24%)  /usr/include/dlang/ldc/std/range/package.d:pure nothrow @safe immutable(char)[] std.path.buildPath
</span></code></pre></div>
<h2 id="summing-it-all-up"><a class="toclink" href="../../2021/12/14/performance-corner-small-changes-pack-a-punch/#summing-it-all-up">Summing it All Up</a></h2>
<p>It was a pretty awesome weekend of work (a few weeks ago now), making some quick changes that will improve <code>Serpent OS</code>
a great deal for a long time to come. This also means we have integrated all the quick format changes so we won't have
to rebuild packages while bringing up the repos.</p>
<p>Here's a quick summary of the results of all these small changes:</p>
<ul>
<li>51% reduction in the uncompressed size of the Index Payload</li>
<li>25% reduction in the compressed size of the Index Payload</li>
<li>29-50% reduction in the uncompressed size of the Layout Payload (much more with fewer files and more locales)</li>
<li>12-15% reduction in the compressed size of the Layout Payload</li>
<li>5% faster package installation for our benchmark (800ms to 760ms)</li>
</ul>
<p>These are some pretty huge numbers and even excluded the massive improvements we made in the previous blog!</p>
<h2 id="what-if-we-include-the-previous-changes"><a class="toclink" href="../../2021/12/14/performance-corner-small-changes-pack-a-punch/#what-if-we-include-the-previous-changes">What if We Include the Previous Changes?</a></h2>
<p>I'm glad you asked, cause I was curious too! Here we see a before and after with all the changes included. For the
<code>Layout Payload</code> we see a ~45% reduction in the compressed and uncompressed size. For the <code>Index Payload</code> we have
reduced the uncompressed size by 67% and the compressed size by 56%. Together resulting in halving the compressed and
uncompressed size of the metadata of our stone packages!</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>Before:
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>Payload: Layout [Records: 5441 Compression: Zstd, Savings: 83.13%, Size: 673.46 KB] (113.61 KB compressed)
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>Payload: Index [Records: 2550 Compression: Zstd, Savings: 55.08%, Size: 247.35 KB] (111.11 KB compressed)
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>After:
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>Payload: Layout [Records: 4718 Compression: Zstd, Savings: 83.62%, Size: 374.42 KB] (61.33 KB compressed)
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>Payload: Index [Records: 2550 Compression: Zstd, Savings: 39.85%, Size: 81.60 KB] (49.01 KB compressed)
</span></code></pre></div>
<p>Now we proceed towards bringing up repos to enjoy our very efficient packages!</p>
    <nav class="md-post__action">
      <a href="../../2021/12/14/performance-corner-small-changes-pack-a-punch/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/19542864" alt="Peter O'Connor">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-12-02 18:07:12+11:00">Thursday, December 2, 2021</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/news/" class="md-meta__link">news</a></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="out-of-the-bootstrap-towards-serpent-os"><a class="toclink" href="../../2021/12/02/out-of-the-bootstrap---towards-serpent-os/">Out of the Bootstrap - Towards Serpent OS</a></h2>
<p>The initial <code>stone</code> packages that will seed the first Serpent OS repo have now been finalized! This means that work
towards setting up the infrastructure for live package updates begins now. We plan on taking time to streamline the
processes with a focus of fixing issues at the source. In this way we can make packaging fast and efficient so we can
spend time working on features rather than package updates.</p>
<!--more-->

<h2 id="the-end-of-bootstrap"><a class="toclink" href="../../2021/12/02/out-of-the-bootstrap---towards-serpent-os/#the-end-of-bootstrap">The End of Bootstrap</a></h2>
<p>Bootstrapping a distribution involves building a new toolchain and many packages needed to support it. For us bootstrap
was getting us to the point where we have built <code>stone</code> packages that we can use to start an initial repository with
full working dependencies. This has been enabled by integrating dependencies into <code>moss</code>, creating the first repo index.
Of note is that it is already enabled for 32bit support, so we have you covered there. While this is the end of
bootstrap, the fun has only just begun!</p>
<p><img alt="The first install from the bootstrap" src="../../../static/img/blog/out-of-the-bootstrap-towards-serpent-os/Featured.webp" /></p>
<h2 id="where-to-next"><a class="toclink" href="../../2021/12/02/out-of-the-bootstrap---towards-serpent-os/#where-to-next">Where to Next?</a></h2>
<p>The next goal is to make Serpent OS self-hosting, where we can build packages in a container and update the repo index
with the newly built packages. It is essentially a live repository accessible from the internet. There's still plenty of
improvements to be made with the tooling, but will soon enable more users to participate in bringing Serpent OS into
fruition.</p>
<h2 id="becoming-more-inclusive"><a class="toclink" href="../../2021/12/02/out-of-the-bootstrap---towards-serpent-os/#becoming-more-inclusive">Becoming More Inclusive</a></h2>
<p>While there's a strong focus in Serpent OS on performance, the decision has been made to lower the initial requirements
for users. Despite AVX2 being an older technology, there are still computers sold today that don't support it. Because
of this (and already having interested users who don't have newer machines), the baseline requirement for Serpent OS
will be <code>x86_64-v2</code>, which only requires SSE4.2.</p>
<p>It was always the plan to add support for these machines, just later down the track. In reality, this makes a lot more
sense, as there will be many cases where building 2 versions of a package provides little value. This is where a package
takes a long time to build and doesn't result in a notable performance improvement. We will always need the <code>x86_64-v2</code>
version of a package to be compatible with the older machines. With this approach we can reduce the build server
requirements without a noticeable impact to users as only a few packages you use will be without extra optimizations
(and probably don't benefit from them anyway).</p>
<p>I want to make it clear that this will be temporary, with impactful <code>x86_64-v3+</code> packages rolling out as soon as
possible. This change paves the way to integrate our technology stack taking care of your system for you and increases
its priority. Users meeting the requirements of the <code>x86_64-v3+</code> instruction set (this includes additional instructions
beyond <code>x86_64-v3</code>) will automatically start installing these faster packages as they become available. Our
<code>subscriptions</code> model will seamlessly take care of everything for you behind the scenes so you don't need to read a
wiki or forum to learn how to get these faster packages. We can utilize the same approach in future for our <code>ARM</code> stack,
offering more optimized packages where it provides the most benefit.</p>
<p>Note that from the bootstrap, most packages built in under 15s and only three took longer than 2 minutes.</p>
<h2 id="trying-out-some-tweaks-from-the-get-go"><a class="toclink" href="../../2021/12/02/out-of-the-bootstrap---towards-serpent-os/#trying-out-some-tweaks-from-the-get-go">Trying Out Some Tweaks From the Get Go</a></h2>
<p>While the project is young is a great time to test out new technologies. The use of <code>clang</code> and <code>lld</code> open up new
possibilities to reduce file sizes, shorten load times and decrease memory usage. Some of these choices may have
impacts on compatibility, so testing them out will be the best way to grasp that. Making sure that you can run apps like
Steam is vital to the experience, so whatever happens we will make sure it works. The good news is that due to the
unique architecture of Serpent OS, we can push updates that break compatibility with just a reboot, so if we ever feel
the need to change the <code>libc</code>, we can make the change without you having to reinstall! More importantly, we can test
major stack updates by rebooting into a staged update and go straight back to the old system, regardless of your file
system.</p>
<h2 id="speed-packaging"><a class="toclink" href="../../2021/12/02/out-of-the-bootstrap---towards-serpent-os/#speed-packaging">Speed Packaging!</a></h2>
<p>In the early days of the repository, tooling to make creating new packages as simple as possible is vital for
efficiency. Spending some time automating as much of the process as possible will take weeks off bringing up Serpent OS.
By making packaging as easy as possible will also help users when creating their own packages. While it would be faster
to work around issues, the build tooling upgrades will benefit everyone.</p>
<p>The other way we'll be speeding up the process is by holding back some of the tuning options by default. <code>LTO</code> for
instance can result in much longer build times so will not initially be the default. The same is true for debug
packages, where it slows down progress without any tangible benefit.</p>
<h2 id="things-are-happening"><a class="toclink" href="../../2021/12/02/out-of-the-bootstrap---towards-serpent-os/#things-are-happening">Things Are Happening!</a></h2>
<p>We hope you are as excited as we are!</p>
    <nav class="md-post__action">
      <a href="../../2021/12/02/out-of-the-bootstrap---towards-serpent-os/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/53261402" alt="Ikey Doherty">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-11-23 23:45:06+00:00">Tuesday, November 23, 2021</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/news/" class="md-meta__link">news</a></li>
        
        
          
          <li class="md-meta__item">
            
              5 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="it-all-depends"><a class="toclink" href="../../2021/11/23/it-all-depends/">It All Depends</a></h2>
<p>It all depends.. it really does. On shared libraries.. interpreters.. <code>pkg-config</code> providers
and packages. It's the same story for all "package managers", how do we ensure that the
installed software has everything it needs at runtime?</p>
<p>Our merry crew has been involved in designing and building Linux distributions for a very, very
long time, so we didn't want to simply repeat history.</p>
<!--more-->

<p><img alt="Using updated moss" src="../../../static/img/blog/it-all-depends/Featured.webp" /></p>
<p>Thanks to many improvements across our codebase, including <code>moss-deps</code>, we automatically analyse
the assets in a package (rapidly too) to determine any dependencies we can add without requiring
the maintainer to list them. This is similar in nature to RPM's behaviour.</p>
<p>As such we encode dependencies into our (endian-aware, binary) format which is then stored in the
local installation database. Global providers are keyed for quick access, and the vast majority
of packages will not explicitly depend on another package's <em>name</em>, rather, they'll depend on
a capability or provider. For subpackage dependencies that usually depend on "NEVRA" equality
(i.e. matching against a name with a minimum version, release, matching epoch and architecture),
we'll introduce a lockstep dependency that can only be resolved from its origin source (repo).</p>
<p>Lastly, we'll always ensure there is no possibility for "partial update" woes. With these
considerations, we have no need to support <code>&gt;=</code> style dependencies, and instead rely on
strict design goals and maintainer responsibility.</p>
<h2 id="first-and-foremost"><a class="toclink" href="../../2021/11/23/it-all-depends/#first-and-foremost">First and foremost!</a></h2>
<p>The rapid move we're enjoying from concept, to prototype, and soon to be fully fledged Linux distribution,
is only possible with the amazing community support. The last few months have seen us pull off some amazing
feats, and we're now executing on our first public milestones. With your help, more and more hours can be
spent getting us ready for release, and would probably help to insulate my shed office! (Spoiler: its
plastic and electric heaters are expensive =))</p>
<h2 id="the-milestones"><a class="toclink" href="../../2021/11/23/it-all-depends/#the-milestones">The Milestones</a></h2>
<p>We have created our initial milestones that our quite literally our escape trajectory from
bootstrap to distro. We're considerably closer now, hence this open announcement.</p>
<h3 id="v00-container-systemd-nspawn"><a class="toclink" href="../../2021/11/23/it-all-depends/#v00-container-systemd-nspawn"><a href="https://gitlab.com/groups/serpent-os/-/milestones/1]">v0.0</a>: Container (<code>systemd-nspawn</code>)</a></h3>
<p>Our first release medium will be a <code>systemd-nspawn</code> compatible container image. Our primary
driver for this is to allow us to add encapsulation for our build tool, <code>boulder</code>, permitting
us to create distributable builder images to seed our infrastructure and first public binary
repository.</p>
<h3 id="v01-bootable-image"><a class="toclink" href="../../2021/11/23/it-all-depends/#v01-bootable-image"><a href="https://gitlab.com/groups/serpent-os/-/milestones/2">v0.1</a>: Bootable "image"</a></h3>
<p>Once our build infra is up and running (honestly a lot of work has been completed for this in
advance) we'll work towards our first 0.1 image. This will initially target VM usage, with
a basic console environment and tooling (<code>moss</code>, <code>boulder</code>, etc).</p>
<h3 id="and-then"><a class="toclink" href="../../2021/11/23/it-all-depends/#and-then">And then..</a></h3>
<p>We have a clear linear path ahead of us, with each stage unlocking the next. During the development
of <code>v0.0</code> and <code>v0.1</code> we'll establish our build and test infrastructure, and begin hosting our
package sources and binaries. At this point we can enter a rapid development cycle with
incremental, and considerable improvements. Such as a usable desktop experience and installer.. :)</p>
<h2 id="recent-changes"><a class="toclink" href="../../2021/11/23/it-all-depends/#recent-changes">Recent changes</a></h2>
<p>I haven't blogged in quite a while, as I've been deep in the trenches working on our core features.
As we've expressed before, we tend to work on the more complex systems <em>first</em> and then glue them
together after to form a cohesive hole. The last few days have involved plenty of glue, and we now
have distinct package management features.</p>
<h3 id="refactor"><a class="toclink" href="../../2021/11/23/it-all-depends/#refactor">Refactor</a></h3>
<ul>
<li>Replaced defunct InstallDB with reusable MetaDB for local installation of archives as well as
   forming the backbone of repository support.</li>
<li>Added <code>ActivePackagesPlugin</code> to identify installed packages</li>
<li>Swapped non cryptographic hash usage with <code>xxhash</code></li>
</ul>
<h3 id="dependencies"><a class="toclink" href="../../2021/11/23/it-all-depends/#dependencies">Dependencies</a></h3>
<ul>
<li>Introduced new Transaction type to utilise a directed acyclical graph for dependency solving.</li>
<li>Reworked moss-deps into plugins + registry core for all resolution operations.</li>
<li>Locally provided <code>.stone</code> files handled by <code>CobblePlugin</code> to ensure we depsolve from this
   set too.</li>
<li>New Transaction set management for identifying state changes and ensuring full resolution
   of target system state.</li>
<li>Shared library and interpreter (DT_INTERP) dependencies and producers automatically encoded
   into packages and resolved by depsolver.</li>
</ul>
<h3 id="package-installation"><a class="toclink" href="../../2021/11/23/it-all-depends/#package-installation">Package Installation</a></h3>
<p>We handle locally provided <code>.stone</code> packages passed to the <code>install</code> command identically to
those found in a repository.  This eliminates a lot of special casing for local archives and
allows us to find dependencies within the provided set, before looking to the system and the
repositories.</p>
<p><img alt="Install" src="/static/img/blog/it-all-depends/Install.webp" title="Installing packages" /></p>
<p>Dependency resolution is performed now for our package installation and is validated at
multiple points, allowing a package like nano to depend on compact automatic dependencies:</p>
<div class="language-d highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="w">    </span><span class="n">Dependency</span><span class="p">(</span><span class="n">DependencyType</span><span class="p">.</span><span class="n">SharedLibraryName</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;libc.so.6(x86_64)&quot;</span><span class="p">);</span>
</span></code></pre></div>
<p>Note our format and database are binary and endian aware. The dependency type only requires
1 byte of storage and no string comparisons.</p>
<h3 id="list-packages"><a class="toclink" href="../../2021/11/23/it-all-depends/#list-packages">List packages</a></h3>
<p>Thanks to the huge refactor, we can now trivially access the installed packages as a list.
This code will be reused for a <code>list available</code> command in future.</p>
<p>Example <code>list installed</code> output:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>                   file (5.4) - File type identification utility
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>             file-32bit (5.4) - Provides 32-bit runtime libraries for file
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>       file-32bit-devel (5.4) - Provides development files for file-32bit
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>             file-devel (5.4) - Development files for file
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>                   nano (5.5) - GNU Text Editor
</span></code></pre></div>
<p><img alt="ListInstalled" src="/static/img/blog/it-all-depends/ListInstalled.webp" title="Listing installed packages" /></p>
<h3 id="inspect-archives"><a class="toclink" href="../../2021/11/23/it-all-depends/#inspect-archives">Inspect archives</a></h3>
<p>For debugging and development purposes, we've moved our old "info" command to a new
"inspect" command to work directly on local <code>.stone</code> files. This displays extended
information on the various payloads and their compression stats.</p>
<p>For general users - the new <code>info</code> command displays basic metadata and package
dependencies.</p>
<p><img alt="Info" src="/static/img/blog/it-all-depends/Info.webp" title="Display package information" /></p>
<h3 id="package-removal"><a class="toclink" href="../../2021/11/23/it-all-depends/#package-removal">Package Removal</a></h3>
<p>Upon generating a new system state, "removed" packages are simply no longer installed. As such
no live mutation is performed. As of today we can now request the removal of packages from the
current state, which generates a new filtered state. Additionally we remove all reverse dependencies,
direct and transitive. This is accomplished by utilising a transposed copy of the directed acyclical
graph, identifying the relevant subgraph and occluding the set from the newly generated state.</p>
<p><img alt="Remove" src="/static/img/blog/it-all-depends/Remove.webp" title="Remove packages" /></p>
<h3 id="lastly"><a class="toclink" href="../../2021/11/23/it-all-depends/#lastly">Lastly</a></h3>
<p>The past few weeks have been especially enjoyable. I've truly had a fantastic time working on the project
and cannot wait for the team and I to start offering our first downloads, and iterate as a truly new
Linux distribution that borrows some ideas from a lot of great places, and fuses them into something
awesome.</p>
<p>Keep toasty - this train isn't slowing down.</p>
    <nav class="md-post__action">
      <a href="../../2021/11/23/it-all-depends/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/19542864" alt="Peter O'Connor">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-11-05 19:23:32+11:00">Friday, November 5, 2021</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/news/" class="md-meta__link">news</a></li>
        
        
          
          <li class="md-meta__item">
            
              5 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="performance-corner-faster-builds-smaller-packages"><a class="toclink" href="../../2021/11/05/performance-corner-faster-builds-smaller-packages/">Performance Corner: Faster Builds, Smaller Packages</a></h2>
<p><code>Performance Corner</code> is a new series where we highlight to you some changes in Serpent OS that may not be obvious, but
show a real improvement. Performance is a broad term that also covers efficiency, so things like making files smaller,
making things faster or reducing power consumption. In general things that are unquestionably improvements with little
or no downside. While the technical details may be of interest to some, the main purpose is to highlight the real
benefit to users and/or developers that will make using Serpent OS a more enjoyable experience. Show me the numbers!</p>
<!--more-->

<p>Here we focus on a few performance changes <code>Ikey</code> has been working on to the build process that are showing some pretty
awesome results! If you end up doing any source builds, you'll be thankful for these improvements. Special thanks to
<code>ermo</code> for the research into hash algorithms and enabling our ELF processing.</p>
<h2 id="start-from-the-beginning"><a class="toclink" href="../../2021/11/05/performance-corner-faster-builds-smaller-packages/#start-from-the-beginning">Start From the Beginning</a></h2>
<p>When measuring changes, it's always important to know where you're starting from. Here are some results from a recent
<code>glibc</code> build, but before these latest changes were incorporated.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>Payload: Layout [Records: 5441 Compression: Zstd, Savings: 83.13%, Size: 673.46 KB]
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>Payload: Index [Records: 2550 Compression: Zstd, Savings: 55.08%, Size: 247.35 KB]
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>Payload: Content [Records: 2550 Compression: Zstd, Savings: 81.46%, Size: 236.72 MB]
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a> ==&gt; &#39;BuildState.Build&#39; finished [4 minutes, 6 secs, 136 ms, 464 μs, and 7 hnsecs]
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a> ==&gt; &#39;BuildState.Analyse&#39; finished [21 secs, 235 ms, 300 μs, and 2 hnsecs]
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a> ==&gt; &#39;BuildState.ProducePackages&#39; finished [25 secs, 624 ms, 996 μs, and 8 hnsecs]
</span></code></pre></div>
<p>The build time is a little high, but a lot of that is due to a slow compiler on the host machine. But analysing and
producing packages was also taking a lot longer than it needed to.</p>
<h2 id="the-death-of-moss-jobs-in-boulder"><a class="toclink" href="../../2021/11/05/performance-corner-faster-builds-smaller-packages/#the-death-of-moss-jobs-in-boulder">The Death of moss-jobs in boulder</a></h2>
<p>In testing an equivalent build outside of <code>boulder</code>, the build stages were about 5% faster. Testing under <code>perf</code>, the
jobs system was a bit excessive for the needs of <code>boulder</code>, polling for work when we already know the times when
parallel jobs would be useful. Removing <code>moss-jobs</code> allowed for simpler codepaths using multiprocessing techniques from
the core language. This work is integrated in <code>moss-deps</code> and the excess overhead of the build has now been eliminated.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>Before:
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a> ==&gt; &#39;BuildState.Build&#39; finished [4 minutes, 6 secs, 136 ms, 464 μs, and 7 hnsecs]
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a> ==&gt; &#39;BuildState.Analyse&#39; finished [21 secs, 235 ms, 300 μs, and 2 hnsecs]
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>After:
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>[Build] Finished: 3 minutes, 53 secs, 386 ms, 306 μs, and 4 hnsecs
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>[Analyse] Finished: 8 secs, 136 ms, 22 μs, and 8 hnsecs
</span></code></pre></div>
<p>The new results reflect a 26s reduction in the overall build time. But only 13s of this relates to the <code>moss-jobs</code>
removal. The other major change is making the analyse stage parallel in <code>moss-deps</code> (a key part of why we wanted
parallelism to begin with). Decreasing the time from 21.2s to 8.1s is a great achievement despite it doing more work as
we've also added ELF scanning for dependency information in-between these results.</p>
<h2 id="new-hashing-algorithm"><a class="toclink" href="../../2021/11/05/performance-corner-faster-builds-smaller-packages/#new-hashing-algorithm">New Hashing Algorithm</a></h2>
<p>One of the unique features in <code>moss</code> is using hashes for file names which allows full deduplication within packages,
the running system, previous system roots and for source builds with <code>boulder</code>. Initially this was hooked up using
<code>sha256</code>, but it was proving to be a bit of a slowdown.</p>
<p>Enter <code>xxhash</code>, the hash algorithm by Yann Collet for use in fast decompression software such as <code>lz4</code> and <code>zstd</code> (and
now in many places!). This is seriously fast, with the potential to produce hashes faster than RAM can feed the CPU. The
hash is merely used as a unique identifier in the context of deduplication, not a cryptographic verification of origin.
<code>XXH3_128bit</code> has been chosen due to it having an almost zero probability of a collision across 10s of millions of
files.</p>
<p>The benefit is actually two-fold. First of all, the hash length is halved from <code>sha256</code>, so there's savings in the
package metadata. This shouldn't be understated as hash data is generally not as compressible as typical text and there
are packages with a lot of files! Here the metadata for the Layout and Index payloads has reduced by 232KB! That's about
a 25% reduction with no other changes.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>Before:
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>Payload: Layout [Records: 5441 Compression: Zstd, Savings: 83.13%, Size: 673.46 KB]
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>Payload: Index [Records: 2550 Compression: Zstd, Savings: 55.08%, Size: 247.35 KB]
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>After:
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>Payload: Layout [Records: 5441 Compression: Zstd, Savings: 86.66%, Size: 522.97 KB]
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>Payload: Index [Records: 2550 Compression: Zstd, Savings: 60.02%, Size: 165.75 KB]
</span></code></pre></div>
<p>Compressed this turns out to be about a 89KB reduction in the package size. For larger packages, this probably doesn't
mean much but could help a lot more with delta packages. For deltas, we will be including the full metadata of the
Layout and Index payloads, so the difference will be more significant there.</p>
<p>The other benefit of course is the speed and the numbers speak for themselves! A further 6.4s reduction in build time
removing most of the delay at the end of the build for the final package. This will also improve speeds for caching or
validating a package.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>Before:
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a> ==&gt; &#39;BuildState.Analyse&#39; finished [21 secs, 235 ms, 300 μs, and 2 hnsecs]
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>After:
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>[Analyse] Finished: 1 sec, 688 ms, 681 μs, and 8 hnsecs
</span></code></pre></div>
<p>With these changes combined, building packages can take 12x less time in the analyse stage, while reducing the size of
the metadata and the overall package. We do expect the analyse time to increase in future as we add more dependency
types, debug handling and stripping, but with the integrated parallel model, we can minimize the increase in time.</p>
<p><img alt="Building" src="../../../static/img/blog/performance-corner-faster-builds-smaller-packages/Featured.webp" /></p>
<h2 id="were-not-done-yet"><a class="toclink" href="../../2021/11/05/performance-corner-faster-builds-smaller-packages/#were-not-done-yet">We're Not Done Yet</a></h2>
<p>The first installment of <code>Performance Corner</code> shows some great wins to the Serpent OS tools and architecture. This is
just the beginning and there will likely be a follow up soon (you may have also noticed that it takes too long to make
the packages), and there's a couple more tweaks to further decrease the size of the metadata. Kudos to <code>Ikey</code> for
getting these implemented!</p>
    <nav class="md-post__action">
      <a href="../../2021/11/05/performance-corner-faster-builds-smaller-packages/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/19542864" alt="Peter O'Connor">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-10-04 16:49:12+11:00">Monday, October 4, 2021</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/news/" class="md-meta__link">news</a></li>
        
        
          
          <li class="md-meta__item">
            
              6 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="optimal-file-locality"><a class="toclink" href="../../2021/10/04/optimal-file-locality/">Optimal File Locality</a></h2>
<p>File locality in this post refers to the order of files in our content payload. Yes that's right, we're focused on the
small details and incremental improvements that combined add up to significant benefits! All of this came about from
testing the efficiency of content payload in <code>moss-format</code> and how well it compared against a plain tarball. One day
<code>boulder</code> was looking extremely inefficient and then retesting the following day was proving to be extremely efficient
without any changes made to <code>boulder</code> or <code>moss-format</code>. What on Earth was going on?</p>
<!--more-->

<h2 id="making-sure-you-arent-going-crazy"><a class="toclink" href="../../2021/10/04/optimal-file-locality/#making-sure-you-arent-going-crazy">Making Sure you Aren't Going Crazy!</a></h2>
<p>To test the efficiency our content payload, the natural choice was to compare it to a tarball containing the same files.
When first running the test the results were quite frankly awful! Our payload was 10% larger than the equivalent
tarball! It was almost unbelievable in a way, so the following day I repeated the test again only this time the content
payload was smaller than the tarball. This didn't actually make sense, I made the tarball with the same files, but
only changed the directory it was created from. Does it really matter?</p>
<h2 id="file-locality-really-matters"><a class="toclink" href="../../2021/10/04/optimal-file-locality/#file-locality-really-matters">File Locality Really Matters!</a></h2>
<p>Of course it does (otherwise it would be a pretty crappy blog post!). When extracting a <code>.stone</code> package it creates two
directories, <code>mossExtract</code> where the sha256sum named files are stored and <code>mossInstall</code> where those files are
hardlinked to their full path name. The first day I created the tarball from <code>mossInstall</code> and the second day I
realised that creating the tarball from <code>mossExtract</code> would provide the closest match to the content payload since it
was a direct comparison. When compressing the tarballs to match the <code>.stone</code> compression level, the tarball compressed
from <code>mossInstall</code> was 10% smaller, despite the uncompressed tarball being slightly larger.</p>
<h2 id="compression-wants-to-separate-apples-and-oranges"><a class="toclink" href="../../2021/10/04/optimal-file-locality/#compression-wants-to-separate-apples-and-oranges">Compression Wants to Separate Apples and Oranges</a></h2>
<p>In simplistic terms, the way compression works is comparing data that it's currently reading versus data that it's read
earlier in the file. <code>zstd</code> has some great options like <code>--long</code> that increases the distance in which these matches can
be made at the cost of increased memory use. To limit memory use while making compression and decompression fast, it
takes shortcuts that reduce the compression ratio. For optimal compression, you want files that are most similar to
each other to be as close as possible. You won't get as many matches from a text file to an ELF file as you would from a
similar looking text file.</p>
<h2 id="spot-the-difference"><a class="toclink" href="../../2021/10/04/optimal-file-locality/#spot-the-difference">Spot the Difference</a></h2>
<p>Files in <code>mossExtract</code> are listed in their sha256sum order, which is basically random, where files in <code>mossInstall</code> are
ordered by their path. Sorting files by path actually does some semblance of sorting where binaries are in <code>/usr/bin</code>
and libraries are in <code>/usr/lib</code> bringing them closer together. This is in no way a perfect order, but is a large
improvement on a random order (up to 10% in our case!).</p>
<p>Our <code>glibc</code> package has been an interesting test case for <code>boulder</code>, where an uncompressed tarball of the install
directory was just under 1GB. As <code>boulder</code> stores files by their sha256sum, it is able to deduplicate files that
are the same even when the build hasn't used symlinks or hardlinks to prevent the wasted space. In this case, the
deduplication reduced the uncompressed size of the payload by 750MB alone (that's a lot of duplicate locale data!). In
the <code>python</code> package, it removes 1,870 duplicate cache files to reduce the installation size.</p>
<p>As part of the deduplication process <code>boulder</code> would sort files by sha256sum to remove duplicate hashes. If two files
have the same sha256sum, then only one copy needs to be stored. It also felt clean with the output of <code>moss info</code>
looking nice where the hashes are listed in alphabetical order. But it was having a significant negative impact on
package sizes so that needed to be addressed by resorting the files by path order (a simple one-liner), making the
content payload more efficient than a tarball once again.</p>
<table>
<thead>
<tr>
<th style="text-align: center;">Compression Level</th>
<th>sha256sum Order</th>
<th>File path Order</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">1</td>
<td>72,724,389</td>
<td>70,924,858</td>
</tr>
<tr>
<td style="text-align: center;">6</td>
<td>65,544,322</td>
<td>63,372,056</td>
</tr>
<tr>
<td style="text-align: center;">12</td>
<td>49,066,505</td>
<td>44,039,782</td>
</tr>
<tr>
<td style="text-align: center;">16</td>
<td>45,365,415</td>
<td>40,785,385</td>
</tr>
<tr>
<td style="text-align: center;">19</td>
<td>26,643,334</td>
<td>24,134,820</td>
</tr>
<tr>
<td style="text-align: center;">22</td>
<td>16,013,048</td>
<td>15,504,806</td>
</tr>
</tbody>
</table>
<p>Testing has shown that higher compression levels (and enabling <code>--long</code>) is more forgiving of a suboptimal file order
(3-11% smaller vs only 2-5% smaller when using <code>--long</code>). The table above is without <code>--long</code> so the difference is
larger.</p>
<h2 id="hang-on-why-dont-you"><a class="toclink" href="../../2021/10/04/optimal-file-locality/#hang-on-why-dont-you">Hang On, Why Don't You...</a></h2>
<p>There's certainly something to this and sorting by file order is a first step. In future we can consider creating an
efficient order for files to improve locality. Putting all the ELF, image or text files together in the payload will
help to shave a bit off our package sizes at only the cost to sort the files. However, we don't want to go crazy here,
the biggest impact on reducing package sizes will be using deltas as the optimal package delivery system (and there will
be a followup on this approach shortly). The <code>moss-format</code> content payload is quite simple and contains no filenames or
paths in it. Therefore it's effectively costless to switch around the order of files, so we can try out a few things and
see what happens.</p>
<h2 id="an-academic-experiment"><a class="toclink" href="../../2021/10/04/optimal-file-locality/#an-academic-experiment">An Academic Experiment</a></h2>
<p>To prove the value of <code>moss-format</code> and the content payload, I tried out some crude sorting methods and their impact on
compression for the package. As you want similar files chunked together, it divided the files into 4 groups, still
sorted by their path order in their corresponding chunk:</p>
<ul>
<li><strong>gz:</strong> gzipped files</li>
<li><strong>data:</strong> non-text files that weren't ELF</li>
<li><strong>elf:</strong> ELF files</li>
<li><strong>text:</strong> text files (bash scripts, perl etc)</li>
</ul>
<p><img alt="Path order vs optimal order" src="../../../static/img/blog/optimal-file-locality/Featured.webp" /></p>
<p>As the chart shows, you can get some decent improvements from reordering files within the tarball when grouping files
in logical chunks. At the highest compression level, the package is reduced by 0.83% without any impact on compression
or decompression time. In the compression world, such a change would be greatly celebrated!</p>
<p>Also important to note was that just moving the gzipped files to the front of the payload was able to capture 40% of the
size improvement at high compression levels, but had slightly worse compression at levels 1-4. So simple changes to the
order (in this case moving non-compressible files to the edge of the payload) can provide a reduction in size at the
higher levels that we care about. We don't want to spend a long time analyzing files for a small reduction in package
size, so we can start off with some basic concepts like this. Moving files that don't compress a lot such as already
compressed files, images and video to the start of payload meaning that the remaining files are closer together. We also
need to test out a broader range of packages and the impact any changes would have on them.</p>
<h2 id="food-for-thought"><a class="toclink" href="../../2021/10/04/optimal-file-locality/#food-for-thought">Food For Thought?</a></h2>
<p>So ultimately the answer to the original question (was <code>moss-format</code> efficient?), the answer is yes! While there are
some things that we still want to change to make it even better, in its current state package creation time was faster
and overheads were lower than with compressing an equivalent tarball. The compressed tarball at <code>zstd -16</code> was 700KB
larger than the full <code>.stone</code> file (which contains a bit more data than the tarball).</p>
<p>The unique format also proves its worth in that we can make further adjustments to increase performance, reduce memory
requirements and reduce package sizes. What this experiment shows is that file order really does matter, but using the
basic sorting method of filepath gets you most of the way there and is likely good enough for most cases.</p>
<p>Here are some questions we can explore in future to see whether there's greater value in tweaking the file order:</p>
<ul>
<li>Do we sort ELF files by path order, file name or by size?</li>
<li>Does it matter the order of chunks in the file? (i.e. ELF-Images-Text vs Images-Text-ELF)</li>
<li>How many categories do we need to segregate and order?</li>
<li>Can we sort by extension? (i.e. for images, all the png files will be together and the jpegs together)</li>
<li>Do we simply make a couple of obvious changes to order and leave <code>zstd</code> to do the heavy lifting?</li>
</ul>
    <nav class="md-post__action">
      <a href="../../2021/10/04/optimal-file-locality/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/19542864" alt="Peter O'Connor">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-09-20 16:04:12+10:00">Monday, September 20, 2021</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/news/" class="md-meta__link">news</a></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="unpacking-the-build-process-part-2"><a class="toclink" href="../../2021/09/20/unpacking-the-build-process-part-2/">Unpacking the Build Process: Part 2</a></h2>
<p>Part 2 looks at the core of the build process, turning the source into compiled code. In Serpent OS this is handled by
our build tool <code>boulder</code>. It is usually the part of the build that takes the longest, so where speed ups have the most
impact. How long it takes is largely down to the performance of your compiler and what compile flags you are building
with.</p>
<!--more-->

<p>This post follows on from <a href="/blog/2021/08/25/unpacking-the-build-process-part-1">Part 1</a>.</p>
<h2 id="turning-source-into-compiled-code"><a class="toclink" href="../../2021/09/20/unpacking-the-build-process-part-2/#turning-source-into-compiled-code">Turning Source into Compiled Code</a></h2>
<p>The steps for compiling code are generally quite straight-forward:
- Setting up the build (cmake, configure, meson)
- Compiling the source (in parallel threads)
- Installing the build into a package directory</p>
<p>This will build software compiled against packages installed on your system. It's a bit more complicated when packaging
as we first set up an environment to compile in (Part 1). But even then you have many choices to make and each can have
an impact on how long it takes to compile the code. Do you build with Link Time Optimizations (LTO) or Profile Guided
Optimizations (PGO), do you build the package for performance or for the smallest size? Then there's packages that
benefit considerably from individual tuning flags (like <code>-fno-semantic-interposition</code> with <code>python</code>). With so many
possibilities, <code>boulder</code> helps us utilize them through convenient configuration options.</p>
<h2 id="what-makes-boulder-so-special"><a class="toclink" href="../../2021/09/20/unpacking-the-build-process-part-2/#what-makes-boulder-so-special">What Makes boulder so Special?</a></h2>
<p>As I do a lot of packaging and performance tuning, <code>boulder</code> is where I spend most of my time. Here are some key
features that <code>boulder</code> brings to make my life easier.</p>
<ul>
<li>Ultimate control over build C/CXX/LDFLAGS via the tuning key</li>
<li>Integrated 2 stage context sensitive PGO builds with a single line workload</li>
<li>Able to switch between <code>gnu</code> and <code>llvm</code> toolchains easily</li>
<li>Rules based package creation</li>
<li>Control the extraction locations for multiple upstream tarballs</li>
</ul>
<p><code>boulder</code> will also be used to generate and amend our <code>stone.yml</code> files to take care of as much as possible
automatically. This is only the beginning for <code>boulder</code> as it will continue to be expanded to learn new tricks to make
packaging more automated and able to bring more information to help packagers know when they can improve their
<code>stone.yml</code>, or alert them that something might be missing.</p>
<p>Serpent OS is focused on the performance of produced packages, even if that means that builds will take longer to
complete. This is why we have put in significant efforts to speed up the compiler and setup tools in order to offset and
minimize the time needed to enable greater performance.</p>
<h2 id="why-do-you-care-so-much-about-setup-time"><a class="toclink" href="../../2021/09/20/unpacking-the-build-process-part-2/#why-do-you-care-so-much-about-setup-time">Why do You Care so Much About Setup Time?</a></h2>
<p>My initial testing focused on the performance of <code>clang</code> as well as the time taken to run <code>cmake</code> and <code>configure</code>. This
lays the foundation for all future work in expanding the Serpent OS package archives at a much faster pace. On the
surface, running <code>cmake</code> can be a small part of the overall build. However, it is important in that it utilizes a single
thread, so is not sped up by adding more CPU cores like the compile time is. With a more compile heavy build, our
highly tuned compiler can build the source in around 75s. So tuning the setup step to run in 5s rather than 10s actually
reduces the overall build time by an additional 6%!</p>
<p>There are many smaller packages where the setup time is an even higher proportion of the overall build and becomes more
relevant as you increase the numbers of threads on the builder. For example, when building <code>nano</code> on the host, the
configure step takes 13.5s, while the build itself takes only 2.3s, so there's significant gains to be had from speeding
up the setup stage of a build (which we will absolutely be taking advantage of!).</p>
<h2 id="a-closer-look-at-the-clang-compilers-performance"><a class="toclink" href="../../2021/09/20/unpacking-the-build-process-part-2/#a-closer-look-at-the-clang-compilers-performance">A Closer Look at the clang Compiler's Performance</a></h2>
<p>A first cut of the compiler results were shared earlier in <a href="../blog/2021/08/02/initial-performance-testing">Initial Performance Testing</a>,
and given the importance to overall build time, I've been taking a closer look. In the post I said that <code>"At stages
where I would have expected to be ahead already, the compile performance was only equal"</code> and now I have identified the
discrepancy.</p>
<p>I've tested multiple configurations for the <code>clang</code> compiler and noticed that changing the default standard C++ library
makes a difference to the time of this particular build. The difference in the two runs is compiling <code>llvm-ar</code> with the
LLVM libraries of <code>compiler-rt/libc++/libunwind</code> or the GNU libraries of <code>libgcc/libstdc++</code>. And just to be clear, this
is increasing the time of compiling <code>llvm-ar</code> with <code>libc++</code> vs <code>libstdc++</code> and not to do with the performance of either
library. The <code>clang</code> compiler itself is built with <code>libc++</code> in both cases as it produces a faster compiler.</p>
<p>{{<figure_screenshot_one image="unpacking-the-build-process-2/Featured" caption="">}}</p>
<table>
<thead>
<tr>
<th>Test using clang</th>
<th>Serpent LLVM libs</th>
<th>Serpent GNU libs</th>
<th>Host</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>cmake</code> LLVM</td>
<td>5.89s</td>
<td>5.67s</td>
<td>10.58s</td>
</tr>
<tr>
<td>Compile -j4 <code>llvm-ar</code></td>
<td>126.16s</td>
<td>112.51s</td>
<td>155.32s</td>
</tr>
<tr>
<td><code>configure</code> gettext</td>
<td>36.64s</td>
<td>36.98s</td>
<td>63.55s</td>
</tr>
</tbody>
</table>
<p>The host now takes <code>38% longer</code> than the Serpent OS clang when building with the same GNU libraries and is much more in
line with my expectations. Next steps will be getting <code>bolt</code> and <code>perf</code> integrated into Serpent OS to see if we can
shave even more time off the build.</p>
<p>What remains unclear is whether this difference is due to something specifically in the <code>LLVM</code> build or whether it would
translate to other C++ packages. I haven't noticed a 10% increase in build time when performing the full compiler
build with <code>libc++</code> vs <code>libstdc++</code>.</p>
    <nav class="md-post__action">
      <a href="../../2021/09/20/unpacking-the-build-process-part-2/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/19542864" alt="Peter O'Connor">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-08-25 19:04:12+10:00">Wednesday, August 25, 2021</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/news/" class="md-meta__link">news</a></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="unpacking-the-build-process-part-1"><a class="toclink" href="../../2021/08/25/unpacking-the-build-process-part-1/">Unpacking the Build Process: Part 1</a></h2>
<p>While the build process (or packaging as it's commonly referred to) is largely hidden to most users, it forms a
fundamental and important aspect to the efficiency of development. In Serpent OS this efficiency also extends to
users via source based builds for packages you may want to try/use that aren't available as binaries upstream.</p>
<!--more-->

<p>The build process can be thought of in three distinct parts, setting up the build environment, compiling the source
and post build analysis plus package creation. Please note that this process hasn't been finalized in Serpent OS so
we will be making further changes to the process where possible.</p>
<h2 id="setting-up-the-build-environment"><a class="toclink" href="../../2021/08/25/unpacking-the-build-process-part-1/#setting-up-the-build-environment">Setting up the Build Environment</a></h2>
<p>Some key parts to setting up the build environment:</p>
<ul>
<li>Downloading packages needed as dependencies for the build</li>
<li>Downloading upstream source files used in the build</li>
<li>Fetching and analyzing the latest repository index</li>
<li>Creating a reproducible environment for the build (chroot, container or VM for example)</li>
<li>Extracting and installing packages into the environment</li>
<li>Extracting tarballs for the build (this is frequently incorporated as part of the build process instead)</li>
</ul>
<p>While the focus of early optimization work has been on build time performance, there's more overhead to creating
packages time than simply compiling code. Now the compiler is in a good place, we can explore the rest of the
build process.</p>
<h2 id="packaging-is-more-than-just-compile-time"><a class="toclink" href="../../2021/08/25/unpacking-the-build-process-part-1/#packaging-is-more-than-just-compile-time">Packaging is More than just Compile Time</a></h2>
<p>There's been plenty of progress in speeding up the creation of the build environment such as parallel downloads to
reduce connection overhead and using <code>zstd</code> for the fast decompression of packages. But there's more that we can
do to provide an optimal experience to our packagers.</p>
<p>Some parts of the process are challenging to optimize as while you can download multiple files at once to ensure
maximum throughput, you are still ultimately limited by your internet speed. When packaging regularly (or building
a single package multiple times), downloaded files are cached so become a one off cost. One part we have taken
particular interest in speeding up is extracting and installing packages into the environment.</p>
<p>{{<figure_screenshot_one image="unpacking-the-build-process-1/Featured" caption="Eight seconds (for a small number of dependencies) that don't need to be endlessly repeated">}}</p>
<h2 id="the-dynamic-duo-boulder-and-moss"><a class="toclink" href="../../2021/08/25/unpacking-the-build-process-part-1/#the-dynamic-duo-boulder-and-moss">The Dynamic Duo: boulder and moss</a></h2>
<p>Installing packages to a clean environment can be the most time consuming part of setting up the build (excluding
fetching files which is highly variable). Serpent OS has a massive advantage with the design of <code>moss</code> where
packages are cached (extracted on disk) and ready to be used by multiple roots, including the creation of clean
build environments for <code>boulder</code>. Having experienced a few build systems in action, setting up the root could take
quite some time with a large number of dependencies (even getting over a minute). <code>moss</code> avoids the cost of extracting
packages entirely every build by utilizing its cache!</p>
<p>There are also secondary benefits to how <code>moss</code> handles packages via its caches where disk writes are reduced by only
needing to extract packages a single time. But hang on, won't you be using <code>tmpfs</code> for builds? Of course we will have
RAM builds as an option and there are benefits there too! When extracting packages to the RAM disk, it consumes memory
which can add up to more than a GB before the build even begins. <code>moss</code> allows for us to start with an empty <code>tmpfs</code> so
we can perform larger builds before exhausting the memory available on our system.</p>
<p>Another great benefit is due to the atomic nature of <code>moss</code>. This means that we can add packages to be cached as
soon as they're fetched while waiting for the remaining files to finish downloading (both for <code>boulder</code> and system
updates). Scheduling jobs becomes much more efficient and we can have the build environment available in moments after
the last file is downloaded!</p>
<p><code>moss</code> allows us to eliminate one of the bigger time sinks in setting up builds, enabling developers and
contributors alike to be more efficient in getting work done for Serpent OS. With greater efficiency it may become
possible to provide a second architecture for older machines (if the demand arises).</p>
<h2 id="part-1"><a class="toclink" href="../../2021/08/25/unpacking-the-build-process-part-1/#part-1">Part 1?</a></h2>
<p>Yes, there's plenty more to discuss so there will be more follow up posts showing the cool features Serpent OS is doing
to both reduce the time taken to build packages and in making packages easier to create so stay tuned!</p>
    <nav class="md-post__action">
      <a href="../../2021/08/25/unpacking-the-build-process-part-1/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/53261402" alt="Ikey Doherty">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-08-10 12:02:37+01:00">Tuesday, August 10, 2021</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/news/" class="md-meta__link">news</a></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="a-rolling-boulder-gathers-no-moss"><a class="toclink" href="../../2021/08/10/a-rolling-boulder-gathers-no-moss/">A Rolling Boulder Gathers No Moss</a></h2>
<p>We actually did it. Super pleased to announce that <code>moss</code> is now capable
of installing and removing packages. Granted, super rough, but gotta start
somewhere right?</p>
<!--more-->

<p><img alt="Transactional system roots + installation in moss" src="../../../static/img/blog/a-rolling-boulder-gathers-no-moss/Featured.webp" /></p>
<p>OK let's recap. A moss archive is super weird, and consists of multiple
containers, or payloads. We use a strongly typed binary format, per-payload
compression (Currently <code>zstd</code>), and don't store files in a typical archive
fashion.</p>
<p>Instead a <code>.stone</code> file (moss archive) has a Content Payload, which is
a compressed "megablob" of all the unique files in a given package. The
various files contained within that "megablob" are described in an IndexPayload,
which simply contains some IDs and offsets, acting much like a lookup table.</p>
<p>That data alone doesn't actually tell us <strong>where files go</strong> on the filesystem
when installed. For that, we have a specialist Layout Payload, encoding the
final layout of the package on disk.</p>
<p>As can be imagined, the weirdness made it quite difficult to install in
a trivial fashion.</p>
<h2 id="databases"><a class="toclink" href="../../2021/08/10/a-rolling-boulder-gathers-no-moss/#databases">Databases</a></h2>
<p>Well, persistence really. Thanks to <code>RocksDB</code> and our new <code>moss-db</code> project,
we can trivially store information we need from each package we "precache".
Primarily, we store full system states within our new StateDB, which at
present is simply a series of package ID selections grouped by a unique
64-bit integer.</p>
<p>Additionally we remember the layouts within the LayoutDB so that we can
eventually recreate said layout on disk.</p>
<h2 id="precaching"><a class="toclink" href="../../2021/08/10/a-rolling-boulder-gathers-no-moss/#precaching">Precaching</a></h2>
<p>Before we actually commit to an install, we try to precache all of the stone
files in our pool. So we unpack the content payload ("megablob"), split it
into various unique files in the pool ready for use. At this point we also
record the Layouts, but do not "install" the package to a system root.</p>
<h2 id="blitting"><a class="toclink" href="../../2021/08/10/a-rolling-boulder-gathers-no-moss/#blitting">Blitting</a></h2>
<p>This is our favourite step. When our cache is populated, we gather all
relevant layouts for the current selections, and then begin applying them
in a <strong>new</strong> system root. All directories and symlinks are created as normal,
whereas any regular file is hardlinked from the pool. This process takes a
fraction of a second and gives us completely clean, deduplicated system roots.</p>
<p>Currently these live in <code>/.moss/store/root/$ID/usr</code>. To complete the transaction,
we update <code>/usr</code> to point to the new <code>usr</code> tree <strong>atomically</strong> assuming that
a reboot isn't needed. In future, boot switch logic will update the tree for us.</p>
<h2 id="removal"><a class="toclink" href="../../2021/08/10/a-rolling-boulder-gathers-no-moss/#removal">Removal</a></h2>
<p>Removal is quite the same as installation. We simply remove the package IDs
from the new state selections (copied from the last state) and blit a new
system root, finally updating the atomic <code>/usr</code> pointer.</p>
<p><img alt="Removal" src="../../../static/img/blog/a-rolling-boulder-gathers-no-moss/Removal.webp" title="Removal of packages with moss. Everything is a transaction" /></p>
<h2 id="tying-it-all-together"><a class="toclink" href="../../2021/08/10/a-rolling-boulder-gathers-no-moss/#tying-it-all-together">Tying it all together</a></h2>
<p>We retain classic package management traits such as having granular selections,
multiple repositories, etc, whilst sporting advanced features like full system
deduplication and transactions/rollbacks.</p>
<p>When we're far enough along, it'll be possible to boot back to the last working
transaction without requiring an internet connection. Due to the use of pooling
and hardlinks, each transaction tree is only a few KiB, with files shared between
each transaction/install.</p>
<h2 id="on-the-list"><a class="toclink" href="../../2021/08/10/a-rolling-boulder-gathers-no-moss/#on-the-list">On the list..</a></h2>
<p>We need some major cleanups, better error handling, logging, timed functions,
and an eventloop driven process to allow parallel fetching/precaching prior
to final system rootfs construction.</p>
<p>It's taken us a very long time to get to this point, and there is still more
work to be done. However this is a major milestone and we can now start
adding features and polish.</p>
<p>Once the required features are in place, we'll work on the much needed
pre alpha ISO :) If you fancy helping us get to that stage quicker, do
check out our OpenCollective! (We won't limit prealpha availability,
don't worry :))</p>
    <nav class="md-post__action">
      <a href="../../2021/08/10/a-rolling-boulder-gathers-no-moss/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/53261402" alt="Ikey Doherty">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-08-03 14:16:16+01:00">Tuesday, August 3, 2021</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/news/" class="md-meta__link">news</a></li>
        
        
          
          <li class="md-meta__item">
            
              2 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="moss-db-progress"><a class="toclink" href="../../2021/08/03/moss-db-progress/">Moss DB Progress</a></h2>
<p>I'll try to make this update as brief as I can but it's certainly an important one, so
let's dive right into it. The last few weeks have been rough but work on our package manager
has still been happening. Today we're happy to reveal another element of the equation: moss-db.</p>
<!--more-->

<p>{{<figure_screenshot_one image="moss-db-progress/Featured" caption="Putting moss-db to the test">}}</p>
<p><code>moss-db</code> is an abstract API providing access to simplistic "Key Value" stores. We had initially used
some payload based files as databases but that introduced various hurdles, so we decided to take
a more abstract approach to not tie ourselves to any specific implementation of a database.</p>
<p>Our main goal with <code>moss-db</code> is to encapsulate the <a href="https://rocksdb.org/">RocksDB</a> library, providing sane, idiomatic access
to a key value store. </p>
<h2 id="high-level-requirements"><a class="toclink" href="../../2021/08/03/moss-db-progress/#high-level-requirements">High level requirements</a></h2>
<p>At the highest level, we needed something that could store arbitrary keys and values, grouped
by some kind of common key (commonly known as "buckets"). We've succeeded in that abstraction,
which also required us to fork a <code>rocksdb-binding</code> to add the <code>Transform</code> APIs required.</p>
<p>Additionally we required idiomatic range behaviours for iteration, as well as generic access
patterns. To that affect we can now <code>foreach</code> a bucket, pipe it through the awesomely powerful
<code>std.algorithm</code> APIs, and automatically encode/decode keys and values through our generic APIs
when implementing the <code>mossdbEncode()</code> and <code>mossdbDecode()</code> functions for a specific <strong>type</strong>.</p>
<p>In a nutshell, this was the old, ugly, hard way:</p>
<div class="language-d highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="w">    </span><span class="cm">/* old, hard way */</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">nameZ</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">name</span><span class="p">.</span><span class="n">toStringz</span><span class="p">();</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">    </span><span class="kt">ubyte</span><span class="p">[</span><span class="kt">int</span><span class="p">.</span><span class="n">sizeof</span><span class="p">]</span><span class="w"> </span><span class="n">ageEncoded</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">nativeToBigEndian</span><span class="p">(</span><span class="n">ageEncoded</span><span class="p">);</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">    </span><span class="n">db</span><span class="p">.</span><span class="n">setDatum</span><span class="p">(</span><span class="k">cast</span><span class="p">(</span><span class="kt">ubyte</span><span class="p">[])</span><span class="w"> </span><span class="p">(</span><span class="n">nameZ</span><span class="p">[</span><span class="mi">0</span><span class="w"> </span><span class="p">..</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">nameZ</span><span class="p">)]),</span><span class="w"> </span><span class="n">ageEncoded</span><span class="p">);</span>
</span></code></pre></div>
<p>And this is the new, shmexy way:</p>
<div class="language-d highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="w">    </span><span class="n">db</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;john&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">    </span><span class="n">db</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;user 100&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;bobby is my name&quot;</span><span class="p">);</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">db</span><span class="p">.</span><span class="n">get</span><span class="p">!</span><span class="kt">int</span><span class="p">(</span><span class="s">&quot;john&quot;</span><span class="p">);</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">found</span><span class="p">)</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">        </span><span class="n">writeln</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">result2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">db</span><span class="p">.</span><span class="n">get</span><span class="p">!</span><span class="nb">string</span><span class="p">(</span><span class="s">&quot;user 100&quot;</span><span class="p">);</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result2</span><span class="p">.</span><span class="n">found</span><span class="p">)</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="w">        </span><span class="n">writeln</span><span class="p">(</span><span class="n">result2</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div>
<p>It's quite easy to see the new API lends itself robustly to our needs, so that
we may implement stateful, strongly typed databases for moss.</p>
<h2 id="next-steps"><a class="toclink" href="../../2021/08/03/moss-db-progress/#next-steps">Next Steps</a></h2>
<p>Even though some APIs in <code>moss-db</code> may still be lacking (remove, for example)
we're happy that it can provide the foundation for our next steps. We now need
to roll out the new <code>StateDB</code>, <code>MetaDB</code> and <code>LayoutDB</code>, to record system states,
package metadata, and filesystem layout information, respectively.</p>
<p>With those 3 basic requirements in place we can combine the respective works
into installation routines. Which, clearly, warrants another blog post ... :)</p>
<p>For now you can see the relevant projects on our <a href="https://gitlab.com/serpent-os/core">GitLab</a> project.</p>
    <nav class="md-post__action">
      <a href="../../2021/08/03/moss-db-progress/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/19542864" alt="Peter O'Connor">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-08-02 11:28:24+10:00">Monday, August 2, 2021</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/news/" class="md-meta__link">news</a></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="initial-performance-testing"><a class="toclink" href="../../2021/08/02/initial-performance-testing/">Initial Performance Testing</a></h2>
<p>With further progress on <code>boulder</code>, we can now build native stone packages with some easy tweaks such as profile
guided optimizations (PGO) and link time optimizations (LTO). That means we can take a first look at what the
performance of the first cut of Serpent OS shows for the future. The tests have been conducted using
<a href="https://github.com/sunnyflunk/benchmarking-tools"><code>benchmarking-tools</code></a> with Serpent OS measured in a <code>chroot</code> on
the same host with the same kernel and config.</p>
<!--more-->

<p>One of the key focuses for early in the project is on reducing build time. Every feature can either add or subtract
from the time it takes to produce a package. With a source/binary hybrid model, users will greatly benefit from the
faster builds as well. In terms of what I've targeted in these tests is the performance of <code>clang</code> and testing some
compiler flag options on <code>cmake</code>.</p>
<h2 id="clang-shows-its-promise"><a class="toclink" href="../../2021/08/02/initial-performance-testing/#clang-shows-its-promise">Clang Shows its Promise</a></h2>
<p><code>clang</code> has always been a compiler with a big future. The performance credentials have also been improving each release
and are now starting to see it perform strongly against its <code>GNU</code> counterpart. It is common to hear that <code>clang</code> is slow
and produces less optimized code. I will admit that most distros provide a slow build of <code>clang</code>, but that will not be
the case in Serpent OS.</p>
<p>It is important to note that in this comparison the Host distro has pulled in some patches from <code>LLVM-13</code> that greatly
improve the performance of <code>clang</code>. Prior to this, their tests actually took <code>50% longer</code> for <code>cmake</code> and <code>configure</code>
but only <code>10% longer</code> for compiling. <code>boulder</code> does not yet support patching in builds so the packages are completely
vanilla.</p>
<table>
<thead>
<tr>
<th>Test using clang</th>
<th>Serpent</th>
<th>Host</th>
<th>Difference</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>cmake</code> LLVM</td>
<td>5.89s</td>
<td>10.58s</td>
<td>79.7%</td>
</tr>
<tr>
<td>Compile -j4 <code>llvm-ar</code></td>
<td>126.16s</td>
<td>155.32s</td>
<td>23.1%</td>
</tr>
<tr>
<td><code>configure</code> gettext</td>
<td>36.64s</td>
<td>63.55s</td>
<td>73.4%</td>
</tr>
</tbody>
</table>
<p>Based on the results during testing, the performance of <code>clang</code> in Serpent OS still has room to improve and was just a
quick tuning pass. At stages where I would have expected to be ahead already, the compile performance was only equal
(but <code>cmake</code> and <code>configure</code> were still well ahead).</p>
<h2 id="gcc-matters-too"><a class="toclink" href="../../2021/08/02/initial-performance-testing/#gcc-matters-too">GCC Matters Too!</a></h2>
<p>While <code>clang</code> is the default compiler in Serpent OS, there may be instances where the performance is not quite where it
could be. It is common to see software have more optimized code paths where they are not tested with <code>clang</code> upstream. As
an example, here's a couple of patches in flac (<a href="https://github.com/xiph/flac/commit/67ea8badadd3e63b8e8af5fe837d075104569330">1</a>,
<a href="https://github.com/xiph/flac/commit/d4a1b345dd16591ff6f17c67ee519afebe2f9792">2</a>) that demonstrate this being improved.
Using <code>benchmarking-tools</code>, it is easy to see where <code>gcc</code> and <code>clang</code> builds are running different functions via <code>perf</code>
results.</p>
<p>In circumstances where the slowdown is due to hitting poor optimization paths in <code>clang</code>, we always have the option to
build packages using <code>gcc</code>, where the <code>GNU</code> toolchain is essential for building <code>glibc</code>. Therefore having a solid <code>GNU</code>
toolchain is important but small compile time improvements won't be noticed by users or developers as much.</p>
<table>
<thead>
<tr>
<th>Test using gcc</th>
<th>Serpent</th>
<th>Host</th>
<th>Difference</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>cmake</code> LLVM</td>
<td>7.00s</td>
<td>7.95s</td>
<td>13.6%</td>
</tr>
<tr>
<td>Compile <code>llvm-ar</code></td>
<td>168.11s</td>
<td>199.07s</td>
<td>18.4%</td>
</tr>
<tr>
<td><code>configure</code> gettext</td>
<td>45.45s</td>
<td>51.93s</td>
<td>14.3%</td>
</tr>
</tbody>
</table>
<h2 id="an-os-is-more-than-just-a-compiler"><a class="toclink" href="../../2021/08/02/initial-performance-testing/#an-os-is-more-than-just-a-compiler">An OS is More Than Just a Compiler</a></h2>
<p>While the current bootstrap exists only as a starting point for building the rest of Serpent OS, there are some other
packages we can easily test and compare. Here's a summary of those results.</p>
<table>
<thead>
<tr>
<th>Test</th>
<th>Serpent</th>
<th>Host</th>
<th>Difference</th>
</tr>
</thead>
<tbody>
<tr>
<td>Pybench</td>
<td>1199.67ms</td>
<td>1024.33ms</td>
<td>-14.6%</td>
</tr>
<tr>
<td><code>xz</code> Compress Kernel (-3 -T1)</td>
<td>42.67s</td>
<td>46.57s</td>
<td>9.1%</td>
</tr>
<tr>
<td><code>xz</code> Compress Kernel (-9 -T4)</td>
<td>71.25s</td>
<td>76.12s</td>
<td>6.8%</td>
</tr>
<tr>
<td><code>xz</code> Decompress Kernel</td>
<td>8.03s</td>
<td>8.18s</td>
<td>1.9%</td>
</tr>
<tr>
<td><code>zlib</code> Compress Kernel</td>
<td>12.60s</td>
<td>13.17s</td>
<td>4.5%</td>
</tr>
<tr>
<td><code>zlib</code> Decompress Kernel</td>
<td>5.14s</td>
<td>5.21s</td>
<td>1.4%</td>
</tr>
<tr>
<td><code>zstd</code> Compress Kernel (-8 -T1)</td>
<td>5.77s</td>
<td>7.06s</td>
<td>22.3%</td>
</tr>
<tr>
<td><code>zstd</code> Compress Kernel (-19 -T4)</td>
<td>51.87s</td>
<td>66.52s</td>
<td>28.3%</td>
</tr>
<tr>
<td><code>zstd</code> Decompress Kernel</td>
<td>2.90s</td>
<td>3.08s</td>
<td>6.3%</td>
</tr>
</tbody>
</table>
<h2 id="state-of-the-bootstrap"><a class="toclink" href="../../2021/08/02/initial-performance-testing/#state-of-the-bootstrap">State of the Bootstrap</a></h2>
<p>From my experiences with testing the bootstrap, it is clear there's some cobwebs in there that require some more iterations
of the toolchain.
There also seems to be some slowdowns in not including all the dependencies of some packages. Once more packages are included,
naturally all the testing will be redone and help influence the default compiler flags of the project.</p>
<p>It's not yet clear the experience of using <code>libc++</code> vs <code>libstdc++</code> with the <code>clang</code> compiler. Once the cobwebs are out and
Serpent OS further developed, the impact (if any) should become more obvious. There are also some parts not yet included in
<code>boulder</code> such as stripping files, LTO and other flags by default that will speed up loading libraries. At this stage this is
deliberate until integrating outputs from builds (such as symbol information).</p>
<p>But this provides an excellent platform to build out the rest of the OS. The raw speed of the <code>clang</code> compiler will make
iterating and expanding the package set a real joy!</p>
<h2 id="hang-on-whats-going-on-with-python"><a class="toclink" href="../../2021/08/02/initial-performance-testing/#hang-on-whats-going-on-with-python">Hang On, What's Going on With Python?</a></h2>
<p>Very astute of you to notice! <code>python</code> in its current state is an absolute minimal build of <code>python</code> in order to run <code>meson</code>.
However, I did an <code>analyze</code> run in <code>benchmarking-tools</code> where it became obvious that they were doing completely different
things.</p>
<p><img alt="Apples and oranges comparison" src="../../../static/img/blog/initial-performance-testing/Featured.webp" /></p>
<p>For now I'll simply be assuming this will sort itself out when <code>python</code> is built complete with all its functionality. And
before anyone wants to point the finger at <code>clang</code>, you get the same result with <code>gcc</code>.</p>
    <nav class="md-post__action">
      <a href="../../2021/08/02/initial-performance-testing/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  <span class="md-pagination__current">1</span> <a class="md-pagination__link" href="page/2/">2</a>
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../2022/" class="md-footer__link md-footer__link--prev" aria-label="Previous: 2022">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                2022
              </div>
            </div>
          </a>
        
        
          
          <a href="../2020/" class="md-footer__link md-footer__link--next" aria-label="Next: 2020">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                2020
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2023-2024 Ikey Doherty, Serpent OS Developers

    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/serpent-os" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
      
    
    
    
      
      
    
    <a href="https://fosstodon.org/@serpentos" target="_blank" rel="noopener me" title="fosstodon.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/Serpent_OS" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8l164.9-188.5L26.8 48h145.6l100.5 132.9L389.2 48zm-24.8 373.8h39.1L151.1 88h-42l255.3 333.8z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.youtube.com/channel/UCyGjpLXzRZdkD0Uc_uZJmaQ" target="_blank" rel="noopener" title="www.youtube.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://matrix.to/#/#serpent-os-space:matrix.org" target="_blank" rel="noopener" title="matrix.to" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M208 352c114.9 0 208-78.8 208-176S322.9 0 208 0 0 78.8 0 176c0 38.6 14.7 74.3 39.6 103.4-3.5 9.4-8.7 17.7-14.2 24.7-4.8 6.2-9.7 11-13.3 14.3-1.8 1.6-3.3 2.9-4.3 3.7-.5.4-.9.7-1.1.8l-.2.2C1 327.2-1.4 334.4.8 340.9S9.1 352 16 352c21.8 0 43.8-5.6 62.1-12.5 9.2-3.5 17.8-7.4 25.3-11.4C134.1 343.3 169.8 352 208 352zm240-176c0 112.3-99.1 196.9-216.5 207 24.3 74.4 104.9 129 200.5 129 38.2 0 73.9-8.7 104.7-23.9 7.5 4 16 7.9 25.2 11.4 18.3 6.9 40.3 12.5 62.1 12.5 6.9 0 13.1-4.5 15.2-11.1 2.1-6.6-.2-13.8-5.8-17.9l-.2-.2c-.2-.2-.6-.4-1.1-.8-1-.8-2.5-2-4.3-3.7-3.6-3.3-8.5-8.1-13.3-14.3-5.5-7-10.7-15.4-14.2-24.7 24.9-29 39.6-64.7 39.6-103.4 0-92.8-84.9-168.9-192.6-175.5.4 5.1.6 10.3.6 15.5z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://forums.serpentos.com/" target="_blank" rel="noopener" title="forums.serpentos.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M144 0a80 80 0 1 1 0 160 80 80 0 1 1 0-160zm368 0a80 80 0 1 1 0 160 80 80 0 1 1 0-160zM0 298.7C0 239.8 47.8 192 106.7 192h42.7c15.9 0 31 3.5 44.6 9.7-1.3 7.2-1.9 14.7-1.9 22.3 0 38.2 16.8 72.5 43.3 96H21.3C9.6 320 0 310.4 0 298.7zM405.3 320h-.7c26.6-23.5 43.3-57.8 43.3-96 0-7.6-.7-15-1.9-22.3 13.6-6.3 28.7-9.7 44.6-9.7h42.7c58.9 0 106.7 47.8 106.7 106.7 0 11.8-9.6 21.3-21.3 21.3H405.3zM224 224a96 96 0 1 1 192 0 96 96 0 1 1-192 0zm-96 261.3c0-73.6 59.7-133.3 133.3-133.3h117.4c73.6 0 133.3 59.7 133.3 133.3 0 14.7-11.9 26.7-26.7 26.7H154.7c-14.7 0-26.7-11.9-26.7-26.7z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/sponsors/ikeycode" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M163.9 136.9c-29.4-29.8-29.4-78.2 0-108s77-29.8 106.4 0l17.7 18 17.7-18c29.4-29.8 77-29.8 106.4 0s29.4 78.2 0 108L310.5 240.1c-6.2 6.3-14.3 9.4-22.5 9.4s-16.3-3.1-22.5-9.4L163.9 136.9zm404.3 199.4c13.1 17.8 9.3 42.8-8.5 55.9l-126.6 93.3c-23.4 17.2-51.6 26.5-80.7 26.5H32c-17.7 0-32-14.3-32-32v-64c0-17.7 14.3-32 32-32h36.8l44.9-36c22.7-18.2 50.9-28 80-28H352c17.7 0 32 14.3 32 32s-14.3 32-32 32h-80c-8.8 0-16 7.2-16 16s7.2 16 16 16h120.6l119.7-88.2c17.8-13.1 42.8-9.3 55.9 8.5zM193.6 384h-.9.9z"/></svg>
    </a>
  
    
    
    
    
    <a href="/feed_rss_created.xml" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M0 64c0-17.7 14.3-32 32-32 229.8 0 416 186.2 416 416 0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96 14.3 96 0 81.7 0 64zm0 352a64 64 0 1 1 128 0 64 64 0 1 1-128 0zm32-256c159.1 0 288 128.9 288 288 0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224-17.7 0-32-14.3-32-32s14.3-32 32-32z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.indexes", "navigation.footer"], "search": "../../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.d7c377c4.min.js"></script>
      
    
  </body>
</html>