
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://serpentos.com/blog/category/news/page/4/">
      
      
        <link rel="prev" href="../../../../">
      
      
        <link rel="next" href="../../../../archive/2024/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS feed" href="../../../../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="../../../../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../../../../static/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.3">
    
    
      
        <title>news - Serpent OS</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.50c56a3b.min.css">
      
        
        <link rel="stylesheet" href="../../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#news" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../.." title="Serpent OS" class="md-header__button md-logo" aria-label="Serpent OS" data-md-component="logo">
      
  <img src="../../../../../static/logo_white.webp" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Serpent OS
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              news
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="light-blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../about/" class="md-tabs__link">
        
  
    
  
  About

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../download/" class="md-tabs__link">
        
  
    
  
  Download

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../privacy/" class="md-tabs__link">
        
  
    
  
  Privacy

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../../" class="md-tabs__link">
          
  
    
  
  Blog

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="Serpent OS" class="md-nav__button md-logo" aria-label="Serpent OS" data-md-component="logo">
      
  <img src="../../../../../static/logo_white.webp" alt="logo">

    </a>
    Serpent OS
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../download/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Download
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../privacy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Privacy
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Blog
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Archive
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2024/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2023/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2021/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2021
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2020/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2020
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" checked>
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Categories
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            Categories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
      
    
  
  
    <li class="md-nav__item">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="../../" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    news
  </span>
  

      </a>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="news">news</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/19542864" alt="Peter O'Connor">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-03-16 22:19:12+00:00">Tuesday, March 16, 2021</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../" class="md-meta__link">news</a></li>
        
        
          
          <li class="md-meta__item">
            
              5 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="optimising-package-distribution"><a class="toclink" href="../../../../2021/03/16/optimising-package-distribution/">Optimising Package Distribution</a></h2>
<p>Getting updates as fast as possible to users has made deltas a popular and sought after feature for distributing
packages. Over the last couple of days, I've been investigating various techniques we can look at to support deltas in
<code>moss</code>.</p>
<!--more-->

<h2 id="trade-offs-between-packages-and-deltas"><a class="toclink" href="../../../../2021/03/16/optimising-package-distribution/#trade-offs-between-packages-and-deltas">Trade-offs Between Packages and Deltas</a></h2>
<p>Minimising the size of updates is particularly valuable where files are downloaded many times and even better if they're
updated infrequently. With a rolling release, packages will be updated frequently, so creating deltas can become
resource intensive, especially if supporting updates over a longer period of time. Therefore it's important to get the
right balance between compression speed, decompression memory and minimising file size.</p>
<table>
<thead>
<tr>
<th></th>
<th>Package priorities</th>
<th>How best to meet these needs</th>
</tr>
</thead>
<tbody>
<tr>
<td>Developers</td>
<td>Creation speed</td>
<td>Quickly created packages</td>
</tr>
<tr>
<td>Users</td>
<td>File size and update speed</td>
<td>Size minimised deltas</td>
</tr>
</tbody>
</table>
<p>From the users point of view, minimising file size and upgrade time are important priorities, but for a developer, the
speed at which packages are created and indexed is vital to progression. Deltas are different to packages in that they
aren't required immediately, so there's minimal impact in taking longer to minimise their size. By getting deltas right,
we can trade-off the size of packages to speed up development, while users will not be affected and fetch only size
optimised deltas.</p>
<h2 id="test-case-qtwebengine"><a class="toclink" href="../../../../2021/03/16/optimising-package-distribution/#test-case-qtwebengine">Test Case - QtWebEngine</a></h2>
<p>QtWebEngine provides a reasonable test case where the package is a mix of binaries, resources and translations, but
above average in size (157.3MB uncompressed). The first trade-off for speed over size has already been made by
incorporating <code>zstd</code> in moss over <code>xz</code>, where even with max compression <code>zstd</code> is already 5.6% larger than using <code>xz</code>.
This is of course due to the amazing decompression speeds where <code>zstd</code> is magnitudes faster.</p>
<p><img alt="Compression levels with zstd" src="../../../../../static/img/blog/optimising-package-distribution/Featured.webp" /></p>
<p>With maximum compression, large packages can take over a minute to compress. With a moderate increase in size, one can
reduce compression time by 2-10x. While making me happier as a developer, it does create extra network load during
updates.</p>
<table>
<thead>
<tr>
<th>Full Package</th>
<th>zstd -16 -T0</th>
<th>zstd -16</th>
<th>zstd -19 -T0</th>
<th>zstd -19</th>
<th>zstd -22</th>
<th>xz -9</th>
</tr>
</thead>
<tbody>
<tr>
<td>Time to create</td>
<td>5.4s</td>
<td>26.8s</td>
<td>27.8s</td>
<td>56.0s</td>
<td>70.6s</td>
<td>66.5s</td>
</tr>
<tr>
<td>Size of package</td>
<td>52.6MB</td>
<td>52.6MB</td>
<td>49.2MB</td>
<td>49.2MB</td>
<td>48.4MB</td>
<td>45.9MB</td>
</tr>
</tbody>
</table>
<h2 id="deltas-to-the-rescue"><a class="toclink" href="../../../../2021/03/16/optimising-package-distribution/#deltas-to-the-rescue">Deltas to the Rescue!</a></h2>
<p>There are two basic methods for deltas. One simple method is to include only files that have been changed since the
earlier release. With reproducible builds, it is typical to create the same file from the same inputs. However, with a
rolling release model, files will frequently have a small change from dependency changes and new versions of the package
itself. In these circumstances the delta size starts to get closer to the full package anyway. As a comparison to other
delta techniques, this approach resulted in a 38.2MB delta as it was a rebuild of the same version at a different time
so the resources and translations were unchanged (and therefore omitted from the delta).</p>
<p>An alternative is a binary diff, which is a significant improvement when files have small changes between releases.
<code>bsdiff</code> has long been used for this purpose and trying it out (without knowing much about it) I managed to create a
delta of 33.2MB, not a bad start at all.</p>
<p>To highlight the weakness of the simple method, when you compare the delta across a version change, the simple delta was
only a 7% reduction of the full package (as most files have changed), while using an optimal binary diff, it still
managed to achieve a respectable 31% size reduction.</p>
<h2 id="a-new-contender"><a class="toclink" href="../../../../2021/03/16/optimising-package-distribution/#a-new-contender">A New Contender</a></h2>
<p>While looking into alternatives, I happened to <a href="https://github.com/facebook/zstd/releases/tag/v1.4.5">stumble across</a>
a new feature in <code>zstd</code> which can be used to create deltas. As we already use <code>zstd</code> heavily it should make integration
easier. <code>--patch-from</code> allows <code>zstd</code> to use the old uncompressed package as a dictionary to create the newer package. In
this way common parts between the releases will be reused in order to reduce the file size. Playing around I quickly
achieved the same size as <code>bsdiff</code>, and with a few tweaks was able to further reduce the delta by a <strong>further 23.5%!</strong>
The best part is that it has the same speedy decompression as <code>zstd</code>, so it will recreate most packages from deltas in
the blink of an eye!</p>
<table>
<thead>
<tr>
<th>Delta</th>
<th>only changed files</th>
<th>bsdiff</th>
<th>zstd -19</th>
<th>zstd -22</th>
<th>zstd -22 --zstd=chainLog=30</th>
</tr>
</thead>
<tbody>
<tr>
<td>Time to create</td>
<td>60.8s</td>
<td>153.0s</td>
<td>85.5s</td>
<td>111.6s</td>
<td>131.8s</td>
</tr>
<tr>
<td>Size of delta</td>
<td>38.2MB</td>
<td>33.2MB</td>
<td>33.3MB</td>
<td>28.5MB</td>
<td>25.4MB</td>
</tr>
</tbody>
</table>
<h2 id="next-steps"><a class="toclink" href="../../../../2021/03/16/optimising-package-distribution/#next-steps">Next Steps</a></h2>
<p>There's certainly a lot of information to digest, but the next step is to integrate a robust delta solution into the
<code>moss</code> format. I really like the <code>zstd</code> approach, where you can tune for speed with an increase in size if desired. With
minimising on delta size, users can benefit from smaller updates while developers can benefit from faster package
creation times.</p>
<p>Some final thoughts for future consideration:</p>
<ul>
<li><code>zstd</code> has seen many improvements over the years, so I believe that ratios and performance will see incremental
improvements over time. Release <a href="https://github.com/facebook/zstd/releases/tag/v1.4.7">1.4.7</a> already brought
significant improvements to deltas (which are reflected in this testing).</li>
<li>The highest compression levels (<code>--ultra</code>) are single threaded in <code>zstd</code>, so delta creation can be done in parallel to
maximise utilisation.</li>
<li>Over optimising the tunables can have a negative impact on both speed and size. As an example,
<code>--zstd=targetLength=4096</code> did result in a 2KB reduction in size at the same speed, but when applied to different inputs
(kernel source tree), it not only made it larger by a few hundred bytes, but added <strong>4 minutes</strong> to delta creation!</li>
<li>Memory usage of applying deltas can be high for large packages (1.74GB for the kernel source tree) as it has to ingest
the full size of the original uncompressed package. It is certainly possible to split up payloads with some delta users
even creating patches on a per file basis. It is a bit more complicated when library names change version numbers each
release with only the SONAME symlink remaining unchanged.</li>
<li>There's always the option to repack packages at higher compression levels later (when deltas are created). This solves
getting the package 'live' ASAP and minimises the size (eventually), but adds some complication.</li>
</ul>
    <nav class="md-post__action">
      <a href="../../../../2021/03/16/optimising-package-distribution/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/53261402" alt="Ikey Doherty">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-02-17 22:35:11+00:00">Wednesday, February 17, 2021</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../" class="md-meta__link">news</a></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="moss-format-read-write-support"><a class="toclink" href="../../../../2021/02/17/moss-format-read-write-support/">Moss Format: Read Write Support</a></h2>
<p>It's been 8 days since our last blogpost and a lot of development work has happened
in that time. Specifically, we've completely reworked the internals of the <code>moss-format</code>
module to support read/write operations.. Which means installation is coming soon (TM)</p>
<!--more-->

<p><img alt="Development work on moss-format" src="../../../../../static/img/blog/moss-format-read-write-support/Featured.webp" /></p>
<p>So, many commits have been made to the core repositories, however the most
important project to focus on right now is <code>moss-format</code>, which we used to
define and implement our binary and source formats. This module is shared
between <code>boulder</code>, our build tool, and <code>moss</code>, our package manager.</p>
<p>We've removed the old enumeration approach from the <code>Reader</code> class, instead
requiring that it processes <strong>data</strong> payloads in-place, deferring reading the
<strong>content</strong> payload streams. We've also enforced strong typing to allow
safe and powerful APIs:</p>
<div class="language-d highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="w">        </span><span class="k">import</span><span class="w"> </span><span class="n">moss</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">binary</span><span class="p">.</span><span class="n">payload</span><span class="p">.</span><span class="n">meta</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">MetaPayload</span><span class="p">;</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">reader</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Reader</span><span class="p">(</span><span class="n">File</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;rb&quot;</span><span class="p">));</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">metadata</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">reader</span><span class="p">.</span><span class="n">payload</span><span class="p">!</span><span class="n">MetaPayload</span><span class="p">();</span>
</span></code></pre></div>
<h2 id="_1"><a class="toclink" href="../../../../2021/02/17/moss-format-read-write-support/#_1"></a></h2>
<p>Right now we can read and write our <code>MetaPayload</code> from and to the stream,
allowing us to encode &amp; decode the metadata associated with the package,
with strong type information (i.e. <code>Uint64</code>, <code>String</code>, etc.)</p>
<h2 id="next-steps"><a class="toclink" href="../../../../2021/02/17/moss-format-read-write-support/#next-steps">Next Steps</a></h2>
<p>We need to restore the <code>IndexPayload</code>, <code>LayoutPayload</code> and <code>ContentPayload</code>
definitions. The first two are simply <strong>data</strong> payloads and will largely
follow the design of the newly reimplemented <code>MetaPayload</code>. Then we restore
<code>ContentPayload</code> support, and this will allow the next steps: unpack, install.</p>
<p>Many of the babysteps required are done now, which power our binary format.
The design of the API is done in a way which will allow powerful manipulation
via the <code>std.algorithm</code> and <code>std.range</code> APIs, enabling extremely simple and
reliable installation routines.</p>
<p>It might seem odd that we've spent so much time on the core <strong>format</strong>,
however I should point out that the design of the format is central to the
OS design. Our installation routine is <strong>not</strong> unpacking of an archive.</p>
<p>With our binary format, the stream contains multiple PayloadHeaders,
with fixed lengths, type, tag, version, and compression information.
It is up to each Payload implementation to then parse the binary
data contained within. Currently our Payloads are compressed using ZSTD, though
other compression algorithms are supported.</p>
<p>So, we have the <code>MetaPayload</code> for metadata. Additionally, we encode all <strong>unique</strong>
files in the package in a single compressed payload, the <code>ContentPayload</code>. The
offset to each unique file (by hash) is stored within the <code>IndexPayload</code>, and
the filesystem layout is encoded as data within the <code>LayoutPayload</code>.</p>
<p>In order to unpack a moss package, the <code>ContentPayload</code> blob will be decompressed
to a temporary location. Then, each struct within the <code>IndexPayload</code> can be used
to copy portions (<code>copy_file_range</code>) of the blob to the cache store for permanence. We skip each Index
if its already present within the cache. Finally, the target filesystem is populated
with a view of all installed packages using the <code>LayoutPayload</code> structs, creating
a shallow installation using hardlinks and directories.</p>
<p>The net result is deep deduplication, atomic updates, and flexibility for the user.
Once we add transactions it'll be possible to boot an older version of the OS using
the deduplication capabilities for offline recovery. Additionally there is no requirement
for file deletion, rename or modification for an update to succeed.</p>
<h2 id="nutshell"><a class="toclink" href="../../../../2021/02/17/moss-format-read-write-support/#nutshell">Nutshell</a></h2>
<p>Huge progress. Major excitement. Such wow. Soon alphas.</p>
    <nav class="md-post__action">
      <a href="../../../../2021/02/17/moss-format-read-write-support/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/53261402" alt="Ikey Doherty">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-02-09 12:45:34+00:00">Tuesday, February 9, 2021</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../" class="md-meta__link">news</a></li>
        
        
          
          <li class="md-meta__item">
            
              2 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="unlocking-moss"><a class="toclink" href="../../../../2021/02/09/unlocking-moss/">Unlocking Moss</a></h2>
<p>Wait, what? Another blog post? In the same WEEK? Yeah totally doing that
now. So, this is just another devlog update but there have been some interesting
updates that we'd like to share.</p>
<!--more-->

<h2 id="ldc-present-in-the-bootstrap"><a class="toclink" href="../../../../2021/02/09/unlocking-moss/#ldc-present-in-the-bootstrap">LDC present in the bootstrap</a></h2>
<p>Thanks to some awesome work from Peter, we now have LDC (The LLVM D Lang Compiler)
present in the stage3 bootstrap. To simplify the process we use the official
binary release of LDC to bootstrap LDC for Serpent OS.</p>
<p>In turn, this has allowed us to get to a point where we can now build <code>moss</code> and
<code>boulder</code> within stage3. This is super important, as we'll use the stage3 chroot
and <code>boulder</code> to produce the binary packages that create stage4.</p>
<p>Some patching has taken place to prevent using <code>ld.gold</code> and instead use <code>lld</code>
to integrate with our toolchain decisions.</p>
<p>{{<figure_screenshot_one image="unlocking-moss/Featured" caption="A wild LDC appears">}}</p>
<h2 id="reworking-the-payload-implementation"><a class="toclink" href="../../../../2021/02/09/unlocking-moss/#reworking-the-payload-implementation">Reworking the Payload implementation</a></h2>
<p>Originally our prototype moss format only contained a <code>ContentPayload</code> for files, and
a <code>MetaPayload</code> for metadata, package information, etc. As a result, we opted for simple
structs, basic case handling and an iterable <code>Reader</code> implementation.</p>
<p>As the format expanded, we bolted deduplication in as a core feature. To achieve this,
we converted the <code>ContentPayload</code> into a "megablob", i.e. every <strong>unique</strong> file in the
package, one after the other, all compressed in one operation. We then store the offsets
and IDs of these files within an <code>IndexPayload</code> to allow splitting the "megablob" into
separate, unique assets. Consequently, we added a <code>LayoutPayload</code> which describes the
final file system layout of the package, referencing the unique ID (hash) of the asset
to install.</p>
<p>So, while the format grew into something we liked, the code supporting it became very
limiting. After many internal debates and discussions, we're going to approach the
format from a different angle on the code front.</p>
<p>It will no longer be necessary/possible to iterate payloads in <em>sequence</em> within a
moss archive, instead we'll preload the data (unparsed) and stick it aside when reading
the file, winding it to the <code>ContentPayload</code> segment if found. After initial loading of
the file is complete, the <code>Reader</code> API will support retrieval (and lazy unpacking ) of
a data segment. In turn this will allow code to "grab" the content, index and layout
payloads and use advanced APIs to cache assets, and apply them to disk in a single
blit operation.</p>
<p>In short, we've unlocked the path to installing moss packages while preserving the
advanced features of the format. The same new APIs will permit introspection of the
archives metadata, and of course, storing these records in a stateful system database.</p>
<h2 id="thank-you-for-the-unnecessary-update"><a class="toclink" href="../../../../2021/02/09/unlocking-moss/#thank-you-for-the-unnecessary-update">Thank you for the unnecessary update</a></h2>
<p>Oh you're quite welcome :P Hopefully now you can see our plan, and that we're on track
to meet our not-28th target. Sure, some code needs throwing away, but all codebases
are evolutionary. Our major hurdle has been solved (mentally) - now it's just time
to implement it and let the good times roll.</p>
    <nav class="md-post__action">
      <a href="../../../../2021/02/09/unlocking-moss/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/53261402" alt="Ikey Doherty">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-02-08 11:50:46+00:00">Monday, February 8, 2021</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../" class="md-meta__link">news</a></li>
        
        
          
          <li class="md-meta__item">
            
              2 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="cleanups-complete"><a class="toclink" href="../../../../2021/02/08/cleanups-complete/">Cleanups Complete</a></h2>
<p>Well, we're officially back to working around the clock. After spending
some time optimising my workflow, I've been busy getting the entire codebase
cleaned up, so we can begin working towards an MVP.</p>
<!--more-->

<p><img alt="Lots and lots of work" src="../../../../../static/img/blog/cleanups-complete/Featured.webp" /></p>
<h2 id="codebase-hygiene"><a class="toclink" href="../../../../2021/02/08/cleanups-complete/#codebase-hygiene">Codebase hygiene</a></h2>
<p>Since Friday, I've been working extensively on cleaning up the codebase for the
following projects:</p>
<ul>
<li>boulder</li>
<li>moss</li>
<li>moss-core</li>
<li>moss-format</li>
</ul>
<p>As it now stands, 1 lint issue (a non-issue, really) exists across all 4
projects. A plethora of issues have been resolved, ranging from endian correctness
in the format to correct idiomatic D-lang integration and module naming.</p>
<h2 id="bored"><a class="toclink" href="../../../../2021/02/08/cleanups-complete/#bored">Bored</a></h2>
<p>Granted, cleanups aren't all that sexy. Peter has been updating many parts of
the bootstrap project, introducing systemd 247.3, LLVM 11.0.1, etc. We now have
all 3 stages building correctly again for the x86_64 target.</p>
<h2 id="and-then"><a class="toclink" href="../../../../2021/02/08/cleanups-complete/#and-then">And then....</a></h2>
<p>Yikes, tough audience! So we've formed a new working TODO which will make its
way online as a public document at some point. The first stage, cleanups, is
done. Next is to restore feature development, working specifically on the
extraction and install routines. From there, much work and cadence will be
unlocked, allowing us to work towards an MVP.</p>
<p><img alt="TODO" src="/static/img/blog/cleanups-complete/TODO.webp" title="See, we organised stuff" /></p>
<h2 id="you-keep-saying-mvp"><a class="toclink" href="../../../../2021/02/08/cleanups-complete/#you-keep-saying-mvp">You keep saying MVP..</a></h2>
<p>I know, it makes me feel all ... cute and professional. At the moment we're cooking up
a high level description of how an MVP demonstration could be deployed. While most of
the features are ambiguous, our current ambition is to deploy a preinstalled QCOW2
Serpent OS image as a prealpha to help validate moss/boulder/etc.</p>
<p>It'll be ugly. Likely slow. Probably insecure as all hell. But it'll be <strong>something</strong>.
It'll allow super basic interaction with moss, and a small collection of utilities that
can be used in a terminal environment. No display whatsoever. That can come in a future
iteration :)</p>
<p>ETA? <del>Definitely not by the 28th of February</del>. When it's done. </p>
<p>{{<giphy "qs6ev2pm8g9dS">}}</p>
    <nav class="md-post__action">
      <a href="../../../../2021/02/08/cleanups-complete/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/53261402" alt="Ikey Doherty">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-10-11 10:17:25+01:00">Sunday, October 11, 2020</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../" class="md-meta__link">news</a></li>
        
        
          
          <li class="md-meta__item">
            
              2 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="build-system-functional"><a class="toclink" href="../../../../2020/10/11/build-system-functional/">Build System Functional</a></h2>
<p>Wow, has it been a hectic few weeks, and it definitely shows: last time
we blogged it was about re-bootstrapping with glibc. Feels like ancient news
already! So, what's new in the world of Serpent OS? Apart from yours truly
now being proud parent to a beautiful baby girl, work has resumed on
the development of Moss, our package manager. And it builds stuff. Awesomely.
Let's quickly catch up with those updates and see where we're headed next.</p>
<!--more-->

<p><img alt="Look at all the buildiness" src="../../../../../static/img/blog/build-system-functional/Featured.webp" /></p>
<h2 id="it-lives"><a class="toclink" href="../../../../2020/10/11/build-system-functional/#it-lives">It lives!</a></h2>
<p>We're now able to build <strong>the majority</strong> of a moss package. Notice I've made
a distinction there. So, we're able to run the build instructions, and use
all of the metadata, configuration and macros available. The only thing
we're not actually doing is dumping the built files into a binary package.</p>
<p>{{<youtube "orhb4yTws4I">}}</p>
<p>We're able to do the build-system part <em>rather well</em>, now. Right now
we support the following features in the build system:</p>
<ul>
<li>Multiple, profile-based architecture support</li>
<li>Automatic <code>-m32</code> profile based cross compilation support for 32-bit libraries on 64-bit OS</li>
<li>Basic Profile Guided Optimisation via the <code>workload</code> key. Set a workload, optimise accordingly.</li>
<li>LLVM Context Sensitive Profile Guided Optimisation. This is default for LLVM with the <code>workload</code> key, and comes for free, with multiple build stages.</li>
<li>Profile based tuning options, such as <code>optimize</code> for speed, size, disabling hardening, etc.</li>
<li>Trivially switch between <code>gnu</code> and <code>llvm</code> toolchain in <code>stone.yml</code>, with profiles knowing the right flags to use with tuning options.</li>
<li>Recursive macro support in build scripts, defined on per-profile level</li>
<li>Architecture specific profiles support in stone.yml, i.e. <code>profiles -&gt; aarch64 -&gt; setup:</code> to avoid if/else spaghetti.</li>
</ul>
<h2 id="next-on-the-agenda"><a class="toclink" href="../../../../2020/10/11/build-system-functional/#next-on-the-agenda">Next on the agenda</a></h2>
<p>Now that the huge amount of scaffolding work has been done, we can actually turn the results of builds
into installable binary packages using our <code>moss.format.binary</code> module. We'll add some magic sauce to
have automatic subpackages + inter-package dependencies, along with the expected automatic runtime
dependencies + such. Cue some linting, et voila, build tool that's a pleasure to work with.</p>
<p>Once we have all those packages building, we'll need a way to install them. Luckily some scaffolding
is in place for this already, and it won't take much effort to support <code>moss install somepkg.stone</code>.
Then we throw a few dozen packages in the mix, add some dependency handling, repo support, Bob's your
uncle, and your aunt is downloading exclusive early-access images from our <a href="https://opencollective.com/serpent-os">Open Collective</a> as soon
as they're available. :O</p>
    <nav class="md-post__action">
      <a href="../../../../2020/10/11/build-system-functional/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/53261402" alt="Ikey Doherty">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-09-22 18:05:39+01:00">Tuesday, September 22, 2020</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../" class="md-meta__link">news</a></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="results-of-the-experiment"><a class="toclink" href="../../../../2020/09/22/results-of-the-experiment/">Results Of The Experiment</a></h2>
<p>It seems like only yesterday we announced to the world a <a href="https://serpentos.com/blog/2020/07/01/the-great-experiment/">Great Experiment</a>.
It was in fact 2 months ago, and a whole lot of work has happened since that point. A few take-homes are immediately clear, the primary
one being the need to be a community-oriented Linux distribution.</p>
<!--more-->

<p>To quote ourselves 2 months ago:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a> If the experiment is a success, which of course means having tight controls on scope and timescale,
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a> then one would assume the primary way to use Serpent OS would be through some downstream repackaging
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a> or reconfiguration, i.e. basing upon the project, to meet specific user demand.
</span></code></pre></div>
<p>It turns out that so far the experiment has been successful, and being forkable is still at the very
heart of our goals. Others have joined us on our journey, and expressed the same passion in our goals
as we have. A community has formed around the project, with individuals sharing the same ambitions
for a reliable, rolling operating system with a powerful package manager.</p>
<p>{{<figure_screenshot_one image="results-of-the-experiment/Featured" caption="Toolchain bootstrap">}}</p>
<h2 id="an-open-community"><a class="toclink" href="../../../../2020/09/22/results-of-the-experiment/#an-open-community">An open community</a></h2>
<p>Over the past 2 months we've transformed from set of ideas into a transparent, community-first organisation
with clear leadership and open goals. I've stepped into the Benevolent Dictator For Life position, and Peter
has taken on daily responsibilities for the project running. Aydemir is now our treasurer on Open Collective,
and many individuals contribute to our project.</p>
<h2 id="transactional-package-management"><a class="toclink" href="../../../../2020/09/22/results-of-the-experiment/#transactional-package-management">Transactional package management</a></h2>
<p>No need to rehash this, but the defining feature of Serpent OS has clearly become moss, something initially
not anticipated when we started. A read-only root filesystem, transactional operations, rollbacks, deduplicating
throughout and atomic updates. Combine that with a rolling release model, stateless policy and ease-of-use,
the core feature-set is already powerful.</p>
<h2 id="deferral-of-musl-integration"><a class="toclink" href="../../../../2020/09/22/results-of-the-experiment/#deferral-of-musl-integration">Deferral of musl integration</a></h2>
<p>In recent weeks we've been working on <code>libwildebeest</code> and <code>libc-support</code>, primarily as a stop-gap to provide
glibc compatibility without using glibc. While musl has many advantages, it is clear to us now that writing
another libc through our support projects isn't what we originally planned. With that in mind we're adopting
glibc and putting our musl works under community ownership, until such time as reevaluation shows that musl is
what is needed in Serpent OS. Note the primary motivator here is investing our efforts where it makes sense,
and obtaining the best results in the most manageable fashion for our users.</p>
<p>Our new toolchain configuration will be as follows:</p>
<ul>
<li>LLVM/clang as primary toolchain</li>
<li>libc++ as C++ library</li>
<li>glibc as C library</li>
<li>gcc+binutils (<code>ld.bfd</code>) provided to build glibc, elfutils, etc.</li>
<li>Permitting per-package builds using GCC, i.e. kernel to alleviate Clang IAS issues.</li>
</ul>
<p>Thus our toolchain will in fact be a hybrid GNU/LLVM one. This will allow both source and binary compatibility
with the majority of desktop + server Linux distributions, facilitating choice of function for our users.</p>
<p>It should be noted this decision has been made after much discussion internally, on our IRC, on our OpenCollective,
etc. Our bootstrap-scripts is being improved to support both <code>glibc</code> and <code>musl</code>, so that the decision can continuously
be reviewed. If we reach a position whereby musl inclusion once again makes sense, thanks to atomic updates
from moss, it will be possible to switch.</p>
<h2 id="final-thoughts"><a class="toclink" href="../../../../2020/09/22/results-of-the-experiment/#final-thoughts">Final thoughts</a></h2>
<p>Initially Serpent OS emerged as a collective agreement on IRC as a set of notions as opinions. Over the past few
months those opinions have solidified into tangible ideas, and a sense of community. In keeping with what is
right for the community, our messaging has been reworked.</p>
<p>It is fair to say our initial stance appeared quite hostile, as a bullet-point list of exhaustion with past
experiences. As we've pivoted to being a fully community-oriented distribution, we've established our goals
of being a reliable, flexible, open, rolling Linux distribution with powerful features imbued by the
package manager, and an upstream-first approach.</p>
<p>As such we've agreed to not let our own pet-peeves interfere with the direction of the project, and instead
enable users to do what they wish on Serpent OS, be it devops, engineering, browsing, gaming, you name it.
We're a general purpose OS with resilience at the core.</p>
<p>Our focus is on the usability and reliability of the OS - thus our efforts will be invested in areas such
as the package manager, hardware enabling, the default experience, etc.</p>
<p>So, strap yourself in, as we're fond of saying. Development of Serpent OS is about to accelerate rapidly.</p>
    <nav class="md-post__action">
      <a href="../../../../2020/09/22/results-of-the-experiment/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/53261402" alt="Ikey Doherty">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-09-21 16:09:46+01:00">Monday, September 21, 2020</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../" class="md-meta__link">news</a></li>
        
        
          
          <li class="md-meta__item">
            
              2 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="source-format-defined"><a class="toclink" href="../../../../2020/09/21/source-format-defined/">Source Format Defined</a></h2>
<p>Following quickly on the heels of yesterday's announcement that the binary format has been defined, we've
now implemented the initial version of our source format. The source format provides metadata on a package
along with instructions on how to build the package.</p>
<!--more-->

<p>The next step of course, is to implement the build tool, converting the source specification into a binary package
that the end user can install. With our 2 formats defined, we can now go ahead and implement the build routines. </p>
<p><img alt="Very trivial package recipe" src="../../../../../static/img/blog/source-format-defined/Featured.webp" /></p>
<h2 id="a-yaml-based-format"><a class="toclink" href="../../../../2020/09/21/source-format-defined/#a-yaml-based-format">A YAML based format</a></h2>
<p>The eagle-eyed among you will already see this is a derivation of the <code>package.yml</code> format I originally created
while at <a href="https://getsol.us">Solus</a>. Minor adaptations to the format have been made to support multiple architectures
via the <code>profiles</code> key, and package splitting behaviour has now been grouped under a <code>packages</code> key to make
the structure more readable.</p>
<p>In <code>package.yml</code>, one would have to redefine subpackage summaries as a key in a list of the primary <code>summary</code> key,
such as:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="w">    </span><span class="nt">rundeps</span><span class="p">:</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">primary-run-dep</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">dev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">secondary-run-dep</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">    </span><span class="nt">summary</span><span class="p">:</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Some Summary</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">dev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Some different summary</span>
</span></code></pre></div>
<p>We've opted to group "Package Definition" behaviour into core structs, which are allowed to appear in the root-level
package and subpackages:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="w">    </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Top-level summary</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">    </span><span class="nt">packages</span><span class="p">:</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">dev</span><span class="p">:</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">            </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Different summary</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">            </span><span class="nt">rundeps</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Different rundeps</span>
</span></code></pre></div>
<h2 id="multiple-architecture-support"><a class="toclink" href="../../../../2020/09/21/source-format-defined/#multiple-architecture-support">Multiple architecture support</a></h2>
<p>In keeping with the grouping behaviour, we're baking multiple architecture configurations into the YML file. A common
issue encountered with the older format was how to handle <code>emul32</code>:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="w">    </span><span class="nt">setup</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">        </span><span class="no">if [[ -z &quot;${EMUL32BUILD}&quot; ]]; then</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">            </span><span class="no">%configure --some-emul32-option</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">        </span><span class="no">else</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">            </span><span class="no">%configure</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">        </span><span class="no">fi</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w">    </span><span class="err">%</span><span class="l l-Scalar l-Scalar-Plain">make</span>
</span></code></pre></div>
<p>Our new approach is to group Build Definitions into the root level struct, which may then individually be overridden for
each architecture. For example:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="w">    </span><span class="nt">profiles</span><span class="p">:</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ia32</span><span class="p">:</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">            </span><span class="nt">setup</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">        </span><span class="err">%</span><span class="l l-Scalar l-Scalar-Plain">configure --some-emul32-option</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">    </span><span class="nt">setup</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="w">    </span><span class="err">%</span><span class="l l-Scalar l-Scalar-Plain">configure</span>
</span></code></pre></div>
<p><img alt="Permutations" src="/static/img/blog/source-format-defined/Permutations.webp" title="More advanced uses of the spec" /></p>
<h2 id="differences"><a class="toclink" href="../../../../2020/09/21/source-format-defined/#differences">Differences</a></h2>
<p>As you can see it is highly similar to package.yml - which is a great format. However, with our tooling and aims being
slightly different, it was time to reevaluate the spec and bolster it where appropriate. We're happy to share our
changes, but in the interest of not causing a conflict between the 2 variants, we'll be calling ours "stone.yml".</p>
<p>Our main motivation came from the tooling, which is written in the D language. With D we were able to create a strongly
typed parser and explicit schema, and with a struct-based approach it made it more trivial to group similar
definitions.</p>
<p>Other than that, we have the same notions with the format, intelligent automatic package splitting, ease of developer
experience, etc.</p>
    <nav class="md-post__action">
      <a href="../../../../2020/09/21/source-format-defined/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/53261402" alt="Ikey Doherty">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-09-20 13:48:50+01:00">Sunday, September 20, 2020</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../" class="md-meta__link">news</a></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="moss-format-defined"><a class="toclink" href="../../../../2020/09/20/moss-format-defined/">Moss Format Defined</a></h2>
<p>The core team have been hard at work lately implementing the <a href="https://github.com/serpent-linux/moss">Moss package manager</a>.
We now have an initial version of the binary format that we're happy with, so we thought we'd share a progress update
with you.</p>
<!--more-->

<p><img alt="Development work on moss" src="../../../../../static/img/blog/moss-format-defined/Featured.webp" /></p>
<h2 id="explaining-the-format"><a class="toclink" href="../../../../2020/09/20/moss-format-defined/#explaining-the-format">Explaining the format</a></h2>
<p>Briefly, the binary container format consists of 4 payloads:</p>
<ul>
<li>Meta (Information on the package)</li>
<li>Content (a binary blob containing all files)</li>
<li>Index (indices to files within the binary blob)</li>
<li>Layout (How to apply the files to disk)</li>
</ul>
<p>Each payload is verified internally using a CRC64-ISO, and contains basic information such as the length of the payload
both compressed and uncompressed, the compression algorithm used (<code>zstd</code> and <code>zlib</code> supported) as well as the type and
version of the payload. All multiple-byte values are stored in Big Endian order (i.e. Network Byte Order).</p>
<p><img alt="Payloads" src="/static/img/blog/moss-format-defined/Payloads.webp" title="All relevant payloads" /></p>
<p>Internally the representation of a Payload is defined as a 32-byte struct:</p>
<div class="language-d highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="w">    </span><span class="nd">@autoEndian</span><span class="w"> </span><span class="n">uint64_t</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="cm">/* 8 bytes */</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">    </span><span class="nd">@autoEndian</span><span class="w"> </span><span class="n">uint64_t</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="cm">/* 8 bytes */</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">    </span><span class="kt">ubyte</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="n">crc64</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="cm">/* CRC64-ISO */</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">    </span><span class="nd">@autoEndian</span><span class="w"> </span><span class="n">uint32_t</span><span class="w"> </span><span class="n">numRecords</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="cm">/* 4 bytes */</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">    </span><span class="nd">@autoEndian</span><span class="w"> </span><span class="n">uint16_t</span><span class="w"> </span><span class="n">payloadVersion</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="cm">/* 2 bytes  */</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">    </span><span class="n">PayloadType</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">PayloadType</span><span class="p">.</span><span class="n">Unknown</span><span class="p">;</span><span class="w"> </span><span class="cm">/* 1 byte  */</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">    </span><span class="n">PayloadCompression</span><span class="w"> </span><span class="n">compression</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">PayloadCompression</span><span class="p">.</span><span class="n">Unknown</span><span class="p">;</span><span class="w"> </span><span class="cm">/* 1 byte */</span>
</span></code></pre></div>
<p>We merge all unique files in a package rootfs into the <code>Content</code> payload, and compress that using zstd. The offsets to
each unique file (i.e. the sha256sum) are stored within the <code>Index</code> payload, allowing us to extract relevant portions
from the "megablob" using <code>copy_file_range()</code>.</p>
<p>These files will become part of the system hash store, allowing another level of deduplication between all system
packages. Finally, we use the <code>Layout</code> payload to <strong>apply</strong> the layout of the package into a transactional rootfs.
This will define paths, such as <code>/usr/bin/nano</code>, along with permissions, types, etc. All regular files will actually
be created as hard links from the hash store, allowing deduplication and snapshots.</p>
<p>The <code>Meta</code> payload consists of a number of records, each with strongly defined types (such as <code>String</code> or <code>Int64</code>) along
with the tag, i.e. <code>Name</code> or <code>Summary</code>. The entire format is binary to ensure greater resilience and a more compact
representation. For example, each metadata key is only 8 bytes.</p>
<div class="language-d highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="w">    </span><span class="nd">@autoEndian</span><span class="w"> </span><span class="n">uint32_t</span><span class="w"> </span><span class="n">length</span><span class="p">;</span><span class="w"> </span><span class="cm">/** 4 bytes per record length*/</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">    </span><span class="nd">@autoEndian</span><span class="w"> </span><span class="n">RecordTag</span><span class="w"> </span><span class="n">tag</span><span class="p">;</span><span class="w"> </span><span class="cm">/** 2 bytes for the tag */</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">    </span><span class="n">RecordType</span><span class="w"> </span><span class="n">type</span><span class="p">;</span><span class="w"> </span><span class="cm">/** 1 byte for the type */</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">    </span><span class="kt">ubyte</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="n">padding</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span></code></pre></div>
<h2 id="tldr-that-for-me"><a class="toclink" href="../../../../2020/09/20/moss-format-defined/#tldr-that-for-me">TLDR that for me...</a></h2>
<p>Binary format that is self deduplicating at several layers, permitting fast transactional operations.</p>
<h2 id="up-next"><a class="toclink" href="../../../../2020/09/20/moss-format-defined/#up-next">Up Next</a></h2>
<p>Before we work any more on the binary format, we now need to pivot to the source format. Our immediate goal is to now
have moss actually <strong>build</strong> packages from source, with resulting <code>.stone</code> packages. Once this step is complete we can
work on installation, upgrades, repositories, etc, and race to becoming a self hosting distribution.</p>
<p>Note, the format may still change before it goes into production, as we encounter more cases for optimisation or
improvement.</p>
    <nav class="md-post__action">
      <a href="../../../../2020/09/20/moss-format-defined/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/53261402" alt="Ikey Doherty">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-09-10 16:02:48+01:00">Thursday, September 10, 2020</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../" class="md-meta__link">news</a></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="defining-moss"><a class="toclink" href="../../../../2020/09/10/defining-moss/">Defining Moss</a></h2>
<p>Over the past few weeks, throughout the entire bootstrap process, we've
been deliberating on what our package manager is going to look like. We
now have a very solid idea on what that'll be, so it's time for a blog
post to share with the community.</p>
<!--more-->

<p><img alt="Initial moss prototype CLI" src="../../../../../static/img/blog/defining-moss/Featured.webp" /></p>
<h2 id="old-but-new"><a class="toclink" href="../../../../2020/09/10/defining-moss/#old-but-new">Old, but new</a></h2>
<p>The team has been very clear in wanting a traditional package management solution,
whereby repositories and packages compose the OS as a whole. However, we also
want modern features, such as being stateless by default. A common theme
is wanting to reduce the complex iterations of an OS into something that
is sanely versioned, but also flexible, to ensure a consistent, tested
experience with multiple end targets.</p>
<p>Additionally, the OS must be incredibly easy for contributors and team members
to maintain, with intelligent tooling and simple, but powerful formats.</p>
<h2 id="atomic-updates"><a class="toclink" href="../../../../2020/09/10/defining-moss/#atomic-updates">Atomic updates</a></h2>
<p>One of the most recent software update trends of recent years is atomic updates.
In essence this allows applying an update in a single operation, and importantly,
reversing an update in a single operation, without impacting the running system.</p>
<p>This is typically achieved using a so-called <code>A/B switch</code>, which is what we will
also do with moss. We won't rely on any specific filesystem for this implementation,
instead relying on a smart layout, <code>pivot_root</code> and a few other tricks.</p>
<p>Primarily we'll update a single <code>/usr</code> symlink to point to the current OS image,
with <code>/</code> being a read-only faux rootfs, populated with established mountpoints
and symlinks. Mutation will be possible only via <code>moss</code> transactions, or in
world-writable locations (<code>/opt</code>, <code>/usr/local</code>, <code>/etc</code> ...)</p>
<h2 id="deduplication"><a class="toclink" href="../../../../2020/09/10/defining-moss/#deduplication">Deduplication</a></h2>
<p>The moss binary package format will be deduplicated in nature, containing hash-keyed
blobs in an <code>zstd</code> compressed payload. Unique blobs will be stored in a global cache,
and hard-linked into their final location (i.e. <code>/moss/root/$number/usr/...</code>) to
deduplicate the installed system too. This allows multiple system snapshots with
minimal overhead, and the ability to perform an offline rollback.</p>
<h2 id="implications"><a class="toclink" href="../../../../2020/09/10/defining-moss/#implications">Implications</a></h2>
<p>We'll need to lock kernels to their relevant transactions (or repo versions) to prevent
untested configurations. Additionally the boot menu will need to know about older versions
of the OS that are installed, so they can be activated in the <code>initrd</code> at boot. This
will require us doing some work with <code>clr-boot-manager</code> to achieve our goals.</p>
<h2 id="difference-from-existing-solutions"><a class="toclink" href="../../../../2020/09/10/defining-moss/#difference-from-existing-solutions">Difference from existing solutions</a></h2>
<p>We're trying to minimise the iterations of the OS to what is available in a given version
of the package repositories. Additionally we wish to avoid extensive "symlink farms"
as we're not a profile-oriented distribution. Instead we focus on deduplication, atomic
updates and resolution performance.</p>
<h2 id="subscriptions"><a class="toclink" href="../../../../2020/09/10/defining-moss/#subscriptions">Subscriptions</a></h2>
<p>Keeping a system slim is often a very difficult thing to achieve, without extensive
package splitting and effort on the user's part. An example might be enabling SELinux
support on a system, or culling the locales to only include the used ones.</p>
<p>In Serpent OS (and moss, more specifically) we intend to address this through "subscriptions".
Well defined names will be used by moss to filter (or enable) certain configurations
in packages + dependencies. In some instances this will toggle subpackages/dependencies
and in others it will control which paths of a package are actually installed to disk.</p>
<p>Going further with this concept, we will eventually introduce modalias based capabilities
to automatically subscribe users to required kernel modules, allowing slim or fullfat
installations as the user chooses. This in turn takes the burden of maintenance away
from developers + users, and enables an incredibly flexible, approachable system.</p>
<h2 id="mandatory-reboots"><a class="toclink" href="../../../../2020/09/10/defining-moss/#mandatory-reboots">Mandatory reboots</a></h2>
<p>Where possible we will limit mandatory reboots, preferring an in-place atomic update
to facilitate high uptime. However, there are situations where a reboot is absolutely
unavoidable, and the system administrator should plan some downtime to handle this
case.</p>
<p>Certain situations like a kernel update, or security fix to a core library, would
require a reboot. In these instances, the atomic update will be deferred until the
next boot. In most situations, however, reboots will not be mandatory.</p>
<h2 id="until-the-next-time"><a class="toclink" href="../../../../2020/09/10/defining-moss/#until-the-next-time">Until the next time</a></h2>
<p>Well, we've given a brief introduction to our aims with <code>moss</code> and associated tooling,
and you can get more information by checking the moss <a href="https://github.com/serpent-linux/moss/blob/main/README.md">README.md</a>.</p>
<p>The takeaway is we want a package-based software update mechanism that is
reliable and trusted, and custom-built to handle Serpent OS intricities,
with a simple approach to building and maintaining the distribution.</p>
<p>For now, we're gonna stop talking, and start coding.</p>
    <nav class="md-post__action">
      <a href="../../../../2020/09/10/defining-moss/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/53261402" alt="Ikey Doherty">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-09-07 18:39:24+01:00">Monday, September 7, 2020</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../" class="md-meta__link">news</a></li>
        
        
          
          <li class="md-meta__item">
            
              2 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="stage3-complete"><a class="toclink" href="../../../../2020/09/07/stage3-complete/">Stage3 Complete</a></h2>
<p>Another week, another milestone completed. We're pleased to announce that
we've completed the initial Stage3 bootstrap. While we have some parallel
works to complete for Stage 4, we can now begin to work on the exciting
pieces! We're now bootstrapped on ARMv8(-a) and x86_64</p>
<!--more-->

<p><img alt="Build" src="/static/img/blog/stage3-complete/Build.webp" title="Complete build-target for x86_64" /></p>
<h2 id="announcing-moss"><a class="toclink" href="../../../../2020/09/07/stage3-complete/#announcing-moss">Announcing Moss</a></h2>
<p>Our immediate focus is now to implement our package manager: <a href="https://github.com/serpent-linux/moss">moss</a>.
Currently it only has a trivial CLI and does absolutely nothing. We will now shift our attention
to implement this as a core part of the Stage 4 bootstrap. Moss is so-called as we're a rolling
release, <em>a rolling stone gathers no moss</em>. The package manager is being implemented in the D Programming Language.</p>
<p>Moss does not aim to be a next generation package management solution, it instead inspired by
eopkg, RPM and swupd, aiming to provide a reliable modern package management and update
solution with stateless design at the core. Core features and automatic dependencies will be managed
through capability subscriptions. The binary format will be versioned and deduplicated, with multiple
internal lookup tables and checksums. Our chief focus with moss is a reliable system
management tool that is accessible even in situations where internet access is limited.</p>
<h2 id="ongoing-works"><a class="toclink" href="../../../../2020/09/07/stage3-complete/#ongoing-works">Ongoing Works</a></h2>
<p>In order to complete stage3, we provided linker stubs in <code>libwildebeest</code> to ensure
we can build. Obviously this introduces runtime errors in systemd and our stage3 isn't
bootable, just chrootable. This will be resolved when systemd is properly packaged by
moss in stage4.</p>
<h2 id="docker-image"><a class="toclink" href="../../../../2020/09/07/stage3-complete/#docker-image">Docker Image</a></h2>
<p>We now have a test container available on Docker Hub. You can install and run the
simple bash environment by executing the following command with a Docker-enabled user:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="w">    </span>docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>--rm<span class="w"> </span>serpentos/staging:latest
</span></code></pre></div>
<p>Currently we only have an x86_64 image, but may experiment with multiarch builds later
in stage4.</p>
<p><strong>IMPORTANT</strong>: The <code>staging</code> image is currently only a dump of the stage3 tree with
minor cleaning + tweakups. It is not, in any way, shape or form, representative of
the final quality of Serpent OS. Additionally zero performance work or security
patching has been done, so do <strong>not</strong> use in a production environment.</p>
<p>The image is provided currently as a means to validate the LLVM/musl toolchain.</p>
<h2 id="future-iso"><a class="toclink" href="../../../../2020/09/07/stage3-complete/#future-iso">Future ISO</a></h2>
<p>We cannot currently say when we'll <strong>definitely</strong> have an ISO, however we do
know that some VM-specific images will arrive first. After that we'll focus
on an installer (package selection based) and a default developer experience.
All we can say is strap in, and enjoy the ride.</p>
    <nav class="md-post__action">
      <a href="../../../../2020/09/07/stage3-complete/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  <a class="md-pagination__link" href="../../">1</a> <a class="md-pagination__link" href="../2/">2</a> <a class="md-pagination__link" href="../3/">3</a> <span class="md-pagination__current">4</span> <a class="md-pagination__link" href="../5/">5</a>
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../../../../" class="md-footer__link md-footer__link--prev" aria-label="Previous: Blog">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Blog
              </div>
            </div>
          </a>
        
        
          
          <a href="../../../../archive/2024/" class="md-footer__link md-footer__link--next" aria-label="Next: 2024">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                2024
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2023-2024 Ikey Doherty, Serpent OS Developers

    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/serpent-os" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
      
    
    
    
      
      
    
    <a href="https://fosstodon.org/@serpentos" target="_blank" rel="noopener me" title="fosstodon.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/Serpent_OS" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8l164.9-188.5L26.8 48h145.6l100.5 132.9L389.2 48zm-24.8 373.8h39.1L151.1 88h-42l255.3 333.8z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.youtube.com/channel/UCyGjpLXzRZdkD0Uc_uZJmaQ" target="_blank" rel="noopener" title="www.youtube.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://matrix.to/#/#serpent-os-space:matrix.org" target="_blank" rel="noopener" title="matrix.to" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M208 352c114.9 0 208-78.8 208-176S322.9 0 208 0 0 78.8 0 176c0 38.6 14.7 74.3 39.6 103.4-3.5 9.4-8.7 17.7-14.2 24.7-4.8 6.2-9.7 11-13.3 14.3-1.8 1.6-3.3 2.9-4.3 3.7-.5.4-.9.7-1.1.8l-.2.2C1 327.2-1.4 334.4.8 340.9S9.1 352 16 352c21.8 0 43.8-5.6 62.1-12.5 9.2-3.5 17.8-7.4 25.3-11.4C134.1 343.3 169.8 352 208 352zm240-176c0 112.3-99.1 196.9-216.5 207 24.3 74.4 104.9 129 200.5 129 38.2 0 73.9-8.7 104.7-23.9 7.5 4 16 7.9 25.2 11.4 18.3 6.9 40.3 12.5 62.1 12.5 6.9 0 13.1-4.5 15.2-11.1 2.1-6.6-.2-13.8-5.8-17.9l-.2-.2c-.2-.2-.6-.4-1.1-.8-1-.8-2.5-2-4.3-3.7-3.6-3.3-8.5-8.1-13.3-14.3-5.5-7-10.7-15.4-14.2-24.7 24.9-29 39.6-64.7 39.6-103.4 0-92.8-84.9-168.9-192.6-175.5.4 5.1.6 10.3.6 15.5z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://forums.serpentos.com/" target="_blank" rel="noopener" title="forums.serpentos.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M144 0a80 80 0 1 1 0 160 80 80 0 1 1 0-160zm368 0a80 80 0 1 1 0 160 80 80 0 1 1 0-160zM0 298.7C0 239.8 47.8 192 106.7 192h42.7c15.9 0 31 3.5 44.6 9.7-1.3 7.2-1.9 14.7-1.9 22.3 0 38.2 16.8 72.5 43.3 96H21.3C9.6 320 0 310.4 0 298.7zM405.3 320h-.7c26.6-23.5 43.3-57.8 43.3-96 0-7.6-.7-15-1.9-22.3 13.6-6.3 28.7-9.7 44.6-9.7h42.7c58.9 0 106.7 47.8 106.7 106.7 0 11.8-9.6 21.3-21.3 21.3H405.3zM224 224a96 96 0 1 1 192 0 96 96 0 1 1-192 0zm-96 261.3c0-73.6 59.7-133.3 133.3-133.3h117.4c73.6 0 133.3 59.7 133.3 133.3 0 14.7-11.9 26.7-26.7 26.7H154.7c-14.7 0-26.7-11.9-26.7-26.7z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/sponsors/ikeycode" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M163.9 136.9c-29.4-29.8-29.4-78.2 0-108s77-29.8 106.4 0l17.7 18 17.7-18c29.4-29.8 77-29.8 106.4 0s29.4 78.2 0 108L310.5 240.1c-6.2 6.3-14.3 9.4-22.5 9.4s-16.3-3.1-22.5-9.4L163.9 136.9zm404.3 199.4c13.1 17.8 9.3 42.8-8.5 55.9l-126.6 93.3c-23.4 17.2-51.6 26.5-80.7 26.5H32c-17.7 0-32-14.3-32-32v-64c0-17.7 14.3-32 32-32h36.8l44.9-36c22.7-18.2 50.9-28 80-28H352c17.7 0 32 14.3 32 32s-14.3 32-32 32h-80c-8.8 0-16 7.2-16 16s7.2 16 16 16h120.6l119.7-88.2c17.8-13.1 42.8-9.3 55.9 8.5zM193.6 384h-.9.9z"/></svg>
    </a>
  
    
    
    
    
    <a href="/feed_rss_created.xml" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M0 64c0-17.7 14.3-32 32-32 229.8 0 416 186.2 416 416 0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96 14.3 96 0 81.7 0 64zm0 352a64 64 0 1 1 128 0 64 64 0 1 1-128 0zm32-256c159.1 0 288 128.9 288 288 0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224-17.7 0-32-14.3-32-32s14.3-32 32-32z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../../../..", "features": ["navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.indexes", "navigation.footer"], "search": "../../../../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.d7c377c4.min.js"></script>
      
    
  </body>
</html>